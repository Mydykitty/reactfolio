===== README.md =====
# ä¸ªäººç®€å†ç½‘ç«™ - React + TypeScript + TailwindCSS

![é¡¹ç›®æˆªå›¾](./screenshot.png)

<div align="center">
  
  [![Vercel](https://img.shields.io/badge/åœ¨çº¿é¢„è§ˆ-000000?style=for-the-badge&logo=vercel&logoColor=white)](https://reactfolio-sooty.vercel.app/)
  [![GitHub](https://img.shields.io/badge/GitHub-100000?style=for-the-badge&logo=github&logoColor=white)](https://github.com/Mydykitty/reactfolio)

</div>

## âœ¨ åœ¨çº¿ä½“éªŒ

ğŸ‘‰ **[ç‚¹å‡»æŸ¥çœ‹åœ¨çº¿ Demo](https://reactfolio-sooty.vercel.app/)**

## ğŸ¯ é¡¹ç›®äº®ç‚¹

- âš¡ **Vite + React** - æé€Ÿå¼€å‘ä½“éªŒ
- ğŸ“˜ **TypeScript** - ç±»å‹å®‰å…¨ï¼Œå‡å°‘bug
- ğŸŒ“ **æ·±è‰²æ¨¡å¼** - æ”¯æŒç³»ç»Ÿä¸»é¢˜è·Ÿéšï¼Œæ‰‹åŠ¨åˆ‡æ¢
- ğŸ“± **å“åº”å¼è®¾è®¡** - æ‰‹æœº/å¹³æ¿/æ¡Œé¢å®Œç¾é€‚é…
- ğŸ¨ **TailwindCSS** - åŸå­åŒ–CSSï¼Œå¼€å‘æ•ˆç‡++

## ğŸ› ï¸ æŠ€æœ¯æ ˆ

- **å‰ç«¯æ¡†æ¶**: React 18
- **è¯­è¨€**: TypeScript
- **æ ·å¼**: TailwindCSS
- **æ„å»ºå·¥å…·**: Vite
- **ä»£ç è§„èŒƒ**: ESLint + Prettier

## ğŸš€ å¿«é€Ÿå¼€å§‹

```bash
# å…‹éš†é¡¹ç›®
git clone https://github.com/Mydykitty/reactfolio.git

# å®‰è£…ä¾èµ–
npm install

# å¼€å‘ç¯å¢ƒ
npm run dev

# ç”Ÿäº§æ„å»º
npm run build

# æœ¬åœ°å¯å‚è€ƒå‘½ä»¤
Cmd + Shift + P â†’ TypeScript: Restart TS Server

npm install react-intersection-observer

npm install -D @vitejs/plugin-vue tailwindcss postcss autoprefixer

npx tailwindcss init

npm install framer-motion

npm install @supabase/supabase-js

npm install zustand

npm install react-markdown remark-gfm rehype-raw

npm install -D @tailwindcss/typography

npm install react-syntax-highlighter
npm install --save-dev @types/react-syntax-highlighter

npm install recharts

# å¤´åƒä¸Šä¼ å’Œç¼–è¾‘ç»„ä»¶
npm install react-avatar-editor

# å¦‚æœéœ€è¦å›¾ç‰‡å‹ç¼©
npm install browser-image-compression

npm install --save-dev @types/react

npm install react-wordcloud

npm install d3 d3-cloud

npm install --save-dev @types/d3 @types/d3-cloud

npm install i18next react-i18next i18next-browser-languagedetector


Settings/Developer settings/ReactFolio

Homepage URLï¼š
  æœ¬åœ°éƒ¨ç½²ï¼šhttp://localhost:5173
  çº¿ä¸Šéƒ¨ç½²ï¼šhttps://reactfolio-sooty.vercel.app/

```

## ğŸš§ å¼€å‘è®¡åˆ’

åŸºç¡€ç®€å†å±•ç¤º

æ·±è‰²æ¨¡å¼åˆ‡æ¢

æ»šåŠ¨åŠ¨ç”»æ•ˆæœ

åšå®¢æ¨¡å—

å¤šè¯­è¨€æ”¯æŒ

å•å…ƒæµ‹è¯•


===== eslint.config.js =====
import js from '@eslint/js'
import globals from 'globals'
import reactHooks from 'eslint-plugin-react-hooks'
import reactRefresh from 'eslint-plugin-react-refresh'
import tseslint from 'typescript-eslint'
import { defineConfig, globalIgnores } from 'eslint/config'

export default defineConfig([
  globalIgnores(['dist']),
  {
    files: ['**/*.{ts,tsx}'],
    extends: [
      js.configs.recommended,
      tseslint.configs.recommended,
      reactHooks.configs.flat.recommended,
      reactRefresh.configs.vite,
    ],
    languageOptions: {
      ecmaVersion: 2020,
      globals: globals.browser,
    },
  },
])


===== postcss.config.js =====
// postcss.config.js
export default {
  plugins: {
    "@tailwindcss/postcss": {},
    autoprefixer: {},
  },
};


===== src/App.tsx =====
import React, { useState, useEffect, lazy, Suspense, useRef} from "react";
import { BrowserRouter, Routes, Route, useLocation } from "react-router-dom"; // æ·»åŠ  useLocation
import Header from "./components/Header";
import About from "./components/About";
import Skills from "./components/Skills";
import Projects from "./components/Projects";
import Contact from "./components/Contact";
import BackToTop from "./components/BackToTop";
import ScrollReveal from "./components/ScrollReveal";
import Guestbook from "./components/Guestbook";
import Button from "./components/common/Button";
import GitHubLogin from "./components/GitHubLogin";
import VisitorCounter from "./components/VisitorCounter";
import LoadingSpinner from "./components/common/LoadingSpinner";
import type { Project, ContactInfo, AboutInfo } from "./types";
import avatarImg from "./assets/avatar.png";
import { useAuthStore } from "./store/authStore";
import { useLikeStore } from "./store/likeStore";
import { supabase } from "./lib/supabase";
import { logVisit } from "./utils/visitLogger"; // å¯¼å…¥è®¿é—®è®°å½•å·¥å…·

// æ‡’åŠ è½½æ‰€æœ‰é¡µé¢ç»„ä»¶
const BlogPage = lazy(() => import("./pages/BlogPage"));
const PostPage = lazy(() => import("./pages/PostPage"));
const ProfilePage = lazy(() => import("./pages/ProfilePage"));
const AdminLayout = lazy(() => import("./components/admin/AdminLayout"));
const PostManager = lazy(() => import("./pages/admin/PostManager"));
const PostEditor = lazy(() => import("./components/admin/PostEditor"));
const CategoryManager = lazy(() => import("./pages/admin/CategoryManager"));
const Dashboard = lazy(() => import("./pages/admin/Dashboard"));
const SourceAnalysis = lazy(() => import("./pages/admin/SourceAnalysis")); // æ–°å¢

// é¡¹ç›®æ•°æ®
const projects: Project[] = [
  {
    name: "ä¸ªäººç®€å†ç½‘é¡µ",
    description:
      "ç”¨React + TypeScriptåˆ¶ä½œçš„ä¸ªäººç®€å†ç½‘é¡µï¼Œæ”¯æŒæ·±è‰²æ¨¡å¼ã€å“åº”å¼è®¾è®¡",
    link: "#",
    category: "react",
    tags: ["React", "TypeScript", "Tailwind"],
  },
  {
    name: "å¾…åŠæ¸…å•åº”ç”¨",
    description: "å…¨æ ˆå¾…åŠåº”ç”¨ï¼ŒReact + Node.js + MongoDB",
    link: "#",
    category: "fullstack",
    tags: ["React", "Node.js", "MongoDB"],
  },
  {
    name: "å¤©æ°”æŸ¥è¯¢å°ç¨‹åº",
    description: "å®æ—¶å¤©æ°”æŸ¥è¯¢ï¼Œè°ƒç”¨ç¬¬ä¸‰æ–¹API",
    link: "#",
    category: "vanilla",
    tags: ["JavaScript", "API"],
  },
];

const contact: ContactInfo = {
  email: "yourname@example.com",
  github: "https://github.com/yourname",
  linkedin: "https://linkedin.com/in/yourname",
};

const about: AboutInfo = {
  bio: "å‰ç«¯å¼€å‘å·¥ç¨‹å¸ˆï¼Œçƒ­çˆ± React å’Œ TypeScriptï¼Œå–œæ¬¢åˆ¶ä½œç®€æ´ç¾è§‚çš„ç½‘é¡µã€‚",
  avatar: avatarImg,
};

// è·¯ç”±ç›‘å¬ç»„ä»¶
const RouteListener: React.FC = () => {
  const location = useLocation();
  const lastLoggedRef = useRef({ path: "", time: 0 });

  useEffect(() => {
    const currentPath = location.pathname + location.search;
    const now = Date.now();

    // 5ç§’å†…ç›¸åŒè·¯å¾„ä¸é‡å¤è®°å½•
    if (
      lastLoggedRef.current.path !== currentPath ||
      now - lastLoggedRef.current.time > 5000
    ) {
      lastLoggedRef.current = { path: currentPath, time: now };
      logVisit();
    }
  }, [location]);

  return null;
};

// åˆ›å»ºä¸»é¡µå¸ƒå±€ç»„ä»¶
const MainLayout: React.FC = () => {
  const [darkMode, setDarkMode] = useState(false);

  const initialize = useAuthStore((state) => state.initialize);
  const user = useAuthStore((state) => state.user);
  const fetchUserLikes = useLikeStore((state) => state.fetchUserLikes);

  // åˆå§‹åŒ–ä¸»é¢˜
  useEffect(() => {
    const savedTheme = localStorage.getItem("theme");
    const isDark = savedTheme === "dark";
    setDarkMode(isDark);
    document.documentElement.classList.toggle("dark", isDark);
  }, []);

  // åˆå§‹åŒ–è®¤è¯å’Œç‚¹èµæ•°æ®
  useEffect(() => {
    initialize();

    const {
      data: { subscription },
    } = supabase.auth.onAuthStateChange((_event, session) => {
      useAuthStore.setState({ user: session?.user || null });
    });

    return () => {
      subscription.unsubscribe();
    };
  }, [initialize]);

  // å½“ç”¨æˆ·ç™»å½•çŠ¶æ€å˜åŒ–æ—¶ï¼Œè·å–ç”¨æˆ·çš„ç‚¹èµæ•°æ®
  useEffect(() => {
    if (user) {
      fetchUserLikes();
    }
  }, [user, fetchUserLikes]);

  // åˆ‡æ¢ä¸»é¢˜
  const toggleTheme = () => {
    setDarkMode((prev) => {
      const newTheme = !prev;
      localStorage.setItem("theme", newTheme ? "dark" : "light");
      document.documentElement.classList.toggle("dark", newTheme);
      return newTheme;
    });
  };

  return (
    <div className="app max-w-3xl mx-auto p-5 bg-white dark:bg-gray-900 text-gray-900 dark:text-white min-h-screen transition-colors duration-300">
      <div className="flex justify-between items-center mb-4">
        <VisitorCounter />
        <div className="flex gap-2">
          <Button onClick={toggleTheme}>
            {darkMode ? "â˜€ï¸ äº®è‰²æ¨¡å¼" : "ğŸŒ™ æš—é»‘æ¨¡å¼"}
          </Button>
          <GitHubLogin />
        </div>
      </div>

      <Header name="å¼ ä¸‰" title="å‰ç«¯å¼€å‘å·¥ç¨‹å¸ˆ" />

      <ScrollReveal>
        <About about={about} />
      </ScrollReveal>

      <ScrollReveal>
        <Skills />
      </ScrollReveal>

      <ScrollReveal>
        <Projects projects={projects} />
      </ScrollReveal>

      <ScrollReveal>
        <Contact contact={contact} />
      </ScrollReveal>

      <ScrollReveal>
        <Guestbook />
      </ScrollReveal>

      <BackToTop />
    </div>
  );
};

// ä¸»åº”ç”¨ç»„ä»¶
const App: React.FC = () => {
  return (
    <BrowserRouter>
      {/* è·¯ç”±ç›‘å¬ç»„ä»¶ */}
      <RouteListener />

      <Suspense fallback={<LoadingSpinner fullScreen text="é¡µé¢åŠ è½½ä¸­..." />}>
        <Routes>
          <Route path="/" element={<MainLayout />} />
          <Route path="/blog" element={<BlogPage />} />
          <Route path="/blog/:slug" element={<PostPage />} />
          <Route path="/profile" element={<ProfilePage />} />

          {/* åå°ç®¡ç†è·¯ç”± */}
          <Route path="/admin" element={<AdminLayout />}>
            <Route index element={<Dashboard />} />
            <Route path="dashboard" element={<Dashboard />} />
            <Route path="posts" element={<PostManager />} />
            <Route path="posts/new" element={<PostEditor />} />
            <Route path="posts/edit/:id" element={<PostEditor />} />
            <Route path="categories" element={<CategoryManager />} />
            <Route path="sources" element={<SourceAnalysis />} />{" "}
            {/* æ–°å¢æ¥æºåˆ†æè·¯ç”± */}
          </Route>
        </Routes>
      </Suspense>
    </BrowserRouter>
  );
};

export default App;


===== src/components/About.tsx =====
import React from "react";
import type { AboutInfo } from "../types";

interface AboutProps {
  about: AboutInfo;
}

const About: React.FC<AboutProps> = ({ about }) => {
  return (
    <section className="py-8 px-6 bg-white dark:bg-gray-800 rounded-lg shadow-md transition-colors duration-300">
      <div className="flex flex-col md:flex-row items-center gap-6">
        {about.avatar && (
          <img
            src={about.avatar}
            alt="å¤´åƒ"
            className="w-32 h-32 rounded-full object-cover border-4 border-gray-200 dark:border-gray-600"
          />
        )}
        <p className="text-lg text-gray-700 dark:text-gray-300 leading-relaxed">
          {about.bio}
        </p>
      </div>
    </section>
  );
};

export default About;


===== src/components/BackToTop.tsx =====
import { useState, useEffect } from "react";
import { motion, AnimatePresence } from "framer-motion";

const BackToTop = () => {
  const [show, setShow] = useState(false);

  useEffect(() => {
    const handleScroll = () => {
      // æ»šåŠ¨è¶…è¿‡400pxæ˜¾ç¤ºæŒ‰é’®
      setShow(window.scrollY > 400);
    };

    window.addEventListener("scroll", handleScroll);
    return () => window.removeEventListener("scroll", handleScroll);
  }, []);

  const scrollToTop = () => {
    window.scrollTo({
      top: 0,
      behavior: "smooth", // å¹³æ»‘æ»šåŠ¨
    });
  };

  return (
    <AnimatePresence>
      {show && (
        <motion.button
          initial={{ opacity: 0, scale: 0.5 }}
          animate={{ opacity: 1, scale: 1 }}
          exit={{ opacity: 0, scale: 0.5 }}
          onClick={scrollToTop}
          className="
            fixed bottom-6 right-6
            p-3 rounded-full
            bg-blue-500 hover:bg-blue-600
            dark:bg-blue-600 dark:hover:bg-blue-700
            text-white shadow-lg
            transition-colors duration-300
            z-50
          "
          aria-label="å›åˆ°é¡¶éƒ¨"
        >
          <svg
            className="w-6 h-6"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              strokeLinecap="round"
              strokeLinejoin="round"
              strokeWidth={2}
              d="M5 10l7-7m0 0l7 7m-7-7v18"
            />
          </svg>
        </motion.button>
      )}
    </AnimatePresence>
  );
};

export default BackToTop;


===== src/components/Contact.tsx =====
import React from "react";
import type { ContactInfo } from "../types";

interface ContactProps {
  contact: ContactInfo;
}

const Contact: React.FC<ContactProps> = ({ contact }) => {
  return (
    <section className="py-8 bg-white dark:bg-gray-800 rounded-lg shadow-md transition-colors duration-300">
      <h2 className="text-2xl font-bold text-gray-900 dark:text-white mb-6 text-center">
        è”ç³»æˆ‘
      </h2>
      <div className="space-y-3">
        <div className="flex items-center gap-3">
          <span className="text-gray-700 dark:text-gray-300">ğŸ“§</span>
          <span className="text-gray-600 dark:text-gray-400">
            {contact.email}
          </span>
        </div>
        <div className="flex items-center gap-3">
          <span className="text-gray-700 dark:text-gray-300">ğŸ’»</span>
          <a
            href={contact.github}
            className="text-blue-600 dark:text-blue-400 hover:underline"
          >
            GitHub
          </a>
        </div>
        <div className="flex items-center gap-3">
          <span className="text-gray-700 dark:text-gray-300">ğŸ‘”</span>
          <a
            href={contact.linkedin}
            className="text-blue-600 dark:text-blue-400 hover:underline"
          >
            LinkedIn
          </a>
        </div>
      </div>
    </section>
  );
};

export default Contact;


===== src/components/GitHubLogin.tsx =====
import React, { useEffect } from "react";
import { useAuthStore } from "../store/authStore";

const GitHubLogin: React.FC = () => {
  const {
    user,
    isLoading,
    error,
    signInWithGitHub,
    signOut,
    clearError,
    initialize,
  } = useAuthStore();

  // åˆå§‹åŒ–è®¤è¯çŠ¶æ€
  useEffect(() => {
    initialize();
  }, []);

  // åŠ è½½çŠ¶æ€
  if (isLoading) {
    return (
      <div className="flex items-center justify-center p-4">
        <div className="animate-spin rounded-full h-6 w-6 border-b-2 border-blue-500"></div>
        <span className="ml-2 text-gray-600 dark:text-gray-400">åŠ è½½ä¸­...</span>
      </div>
    );
  }

  // å·²ç™»å½•çŠ¶æ€
  if (user) {
    return (
      <div className="flex items-center gap-4 p-4 bg-white dark:bg-gray-800 rounded-lg shadow">
        <img
          src={user.user_metadata.avatar_url}
          alt={user.user_metadata.user_name}
          className="w-10 h-10 rounded-full border-2 border-blue-500"
        />
        <div className="flex-1">
          <p className="font-medium text-gray-900 dark:text-white">
            {user.user_metadata.user_name}
          </p>
          <p className="text-sm text-gray-500 dark:text-gray-400">
            {user.email}
          </p>
        </div>
        <button
          onClick={signOut}
          className="px-4 py-2 text-sm bg-red-500 hover:bg-red-600 text-white rounded-lg transition-colors"
        >
          é€€å‡º
        </button>
      </div>
    );
  }

  // æœªç™»å½•çŠ¶æ€
  return (
    <div className="p-4 bg-white dark:bg-gray-800 rounded-lg shadow">
      {error && (
        <div className="mb-4 p-3 bg-red-100 dark:bg-red-900/30 text-red-700 dark:text-red-300 rounded-lg flex justify-between items-center">
          <span>{error}</span>
          <button
            onClick={clearError}
            className="text-red-500 hover:text-red-700"
          >
            âœ•
          </button>
        </div>
      )}

      <button
        onClick={signInWithGitHub}
        disabled={isLoading}
        className="w-full flex items-center justify-center gap-3 px-4 py-3 bg-gray-900 hover:bg-gray-800 text-white rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
      >
        <svg className="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
          <path
            fillRule="evenodd"
            d="M12 2C6.477 2 2 6.484 2 12.017c0 4.425 2.865 8.18 6.839 9.504.5.092.682-.217.682-.483 0-.237-.008-.868-.013-1.703-2.782.605-3.369-1.343-3.369-1.343-.454-1.158-1.11-1.466-1.11-1.466-.908-.62.069-.608.069-.608 1.003.07 1.531 1.032 1.531 1.032.892 1.53 2.341 1.088 2.91.832.092-.647.35-1.088.636-1.338-2.22-.253-4.555-1.113-4.555-4.951 0-1.093.39-1.988 1.029-2.688-.103-.253-.446-1.272.098-2.65 0 0 .84-.27 2.75 1.026A9.564 9.564 0 0112 6.844c.85.004 1.705.115 2.504.337 1.909-1.296 2.747-1.027 2.747-1.027.546 1.379.202 2.398.1 2.651.64.7 1.028 1.595 1.028 2.688 0 3.848-2.339 4.695-4.566 4.943.359.309.678.92.678 1.855 0 1.338-.012 2.419-.012 2.747 0 .268.18.58.688.482A10.019 10.019 0 0022 12.017C22 6.484 17.522 2 12 2z"
            clipRule="evenodd"
          />
        </svg>
        <span className="font-medium">ä½¿ç”¨ GitHub ç™»å½•</span>
      </button>

      <p className="mt-3 text-xs text-center text-gray-500 dark:text-gray-400">
        ç™»å½•åå¯ä»¥ç•™è¨€ã€ç‚¹èµ âœ¨
      </p>
    </div>
  );
};

export default GitHubLogin;


===== src/components/Guestbook.tsx =====
// src/components/Guestbook.tsx
import { useState, useEffect, useCallback, useRef } from "react";
import { supabase } from "../lib/supabase";
import { useAuthStore } from "../store/authStore";
import { useLikeStore } from "../store/likeStore";
import type { MessageWithLike } from "../types";
import GuestbookMessage from "./GuestbookMessage";
import GuestbookWordCloud from "./GuestbookWordCloud"; // å¯¼å…¥è¯äº‘ç»„ä»¶

const PAGE_SIZE = 10;

const Guestbook = () => {
  const [messages, setMessages] = useState<MessageWithLike[]>([]);
  const [content, setContent] = useState("");
  const [loading, setLoading] = useState(false);
  const [page, setPage] = useState(1);
  const [hasMore, setHasMore] = useState(true);
  const [total, setTotal] = useState(0);
  const [showWordCloud, setShowWordCloud] = useState(false);

  const user = useAuthStore((state) => state.user);
  const { likedMessages, fetchUserLikes, toggleLike } = useLikeStore();

  // æ–°å¢ï¼šé˜²é‡å¤è¯·æ±‚ ref
  const fetchingRef = useRef(false);

  // ä¿®æ”¹1ï¼šç¨³å®šçš„ fetchMessagesï¼ˆä¾èµ–æ•°ç»„ä¸ºç©ºï¼‰
  const fetchMessages = useCallback(async (pageNum: number) => {
    // é˜²æ­¢é‡å¤è¯·æ±‚
    if (fetchingRef.current) return;

    fetchingRef.current = true;
    setLoading(true);

    const from = (pageNum - 1) * PAGE_SIZE;
    const to = from + PAGE_SIZE - 1;

    const { data, error } = await supabase
      .from("messages")
      .select("*")
      .order("is_pinned", { ascending: false }) // ç½®é¡¶çš„æ’åœ¨å‰é¢
      .order("created_at", { ascending: false })
      .range(from, to);

    if (error) {
      console.error("Error fetching messages:", error);
      fetchingRef.current = false;
      setLoading(false);
      return;
    }

    if (data) {
      // ç›´æ¥ä» store è·å–æœ€æ–°çš„ç‚¹èµçŠ¶æ€
      const currentLikedMessages = useLikeStore.getState().likedMessages;
      const messagesWithLike = data.map((msg) => ({
        ...msg,
        liked_by_user: currentLikedMessages.has(msg.id),
      }));

      if (pageNum === 1) {
        setMessages(messagesWithLike);
      } else {
        setMessages((prev) => [...prev, ...messagesWithLike]);
      }

      setHasMore(data.length === PAGE_SIZE);
    }

    fetchingRef.current = false;
    setLoading(false);
  }, []); // ç©ºæ•°ç»„ï¼Œå‡½æ•°æ°¸ä¸é‡æ–°åˆ›å»º

  // ä¿®æ”¹2ï¼šåˆå§‹åŒ–åªæ‰§è¡Œä¸€æ¬¡
  useEffect(() => {
    const init = async () => {
      // è·å–æ€»æ•°
      const { count } = await supabase
        .from("messages")
        .select("*", { count: "exact", head: true });
      setTotal(count || 0);

      // å¦‚æœå·²ç™»å½•ï¼Œè·å–ç‚¹èµæ•°æ®
      if (user) {
        await fetchUserLikes();
      }

      // è·å–ç¬¬ä¸€é¡µç•™è¨€
      await fetchMessages(1);
    };

    init();
  }, []); // ç©ºæ•°ç»„ï¼Œåªæ‰§è¡Œä¸€æ¬¡

  // ä¿®æ”¹3ï¼šåˆ†é¡µåŠ è½½
  useEffect(() => {
    if (page > 1) {
      // é¿å…ç¬¬ä¸€é¡µé‡å¤åŠ è½½
      fetchMessages(page);
    }
  }, [page]); // åªä¾èµ– page

  // åªåœ¨ç»„ä»¶æŒ‚è½½æ—¶åŒæ­¥ä¸€æ¬¡ç‚¹èµçŠ¶æ€
  useEffect(() => {
    if (messages.length > 0 && likedMessages.size > 0) {
      setMessages((prev) =>
        prev.map((msg) => ({
          ...msg,
          liked_by_user: likedMessages.has(msg.id),
        })),
      );
    }
  }, []); // åªåœ¨ç»„ä»¶æŒ‚è½½æ—¶æ‰§è¡Œä¸€æ¬¡

  // å‘å¸ƒç•™è¨€
  const submitMessage = async (e: React.FormEvent) => {
    e.preventDefault();

    if (!user) {
      alert("è¯·å…ˆç™»å½•åå†ç•™è¨€");
      return;
    }

    if (!content.trim()) return;

    setLoading(true);
    const { error, data } = await supabase
      .from("messages")
      .insert([
        {
          name: user.user_metadata?.user_name || "åŒ¿å",
          content,
          user_id: user.id,
          avatar_url: user.user_metadata?.avatar_url,
          likes_count: 0,
        },
      ])
      .select()
      .single();

    if (!error && data) {
      setContent("");
      setPage(1);
      fetchMessages(1);
      // æ›´æ–°æ€»æ•°
      const { count } = await supabase
        .from("messages")
        .select("*", { count: "exact", head: true });
      setTotal(count || 0);
    }
    setLoading(false);
  };

  // å¤„ç†ç‚¹èµ
  const handleLike = async (messageId: number) => {
    if (!user) {
      alert("è¯·å…ˆç™»å½•åå†ç‚¹èµ");
      return;
    }

    // ä¹è§‚æ›´æ–° UI
    setMessages((prev) =>
      prev.map((msg) => {
        if (msg.id === messageId) {
          return {
            ...msg,
            likes_count: (msg.likes_count || 0) + (msg.liked_by_user ? -1 : 1),
            liked_by_user: !msg.liked_by_user,
          };
        }
        return msg;
      }),
    );

    // è°ƒç”¨ store çš„ toggleLike
    await toggleLike(messageId);
  };

  // åŠ è½½æ›´å¤š
  const loadMore = () => {
    if (hasMore && !loading && !fetchingRef.current) {
      setPage((prev) => prev + 1);
    }
  };

  // ç¼–è¾‘ç•™è¨€
  const handleEdit = async (messageId: number, newContent: string) => {
    if (!user) return;

    try {
      const { error } = await supabase
        .from("messages")
        .update({ content: newContent })
        .eq("id", messageId)
        .eq("user_id", user.id);

      if (error) throw error;

      // æ›´æ–°æœ¬åœ°çŠ¶æ€
      setMessages((prev) =>
        prev.map((msg) =>
          msg.id === messageId ? { ...msg, content: newContent } : msg,
        ),
      );
    } catch (error) {
      console.error("Error editing message:", error);
      alert("ç¼–è¾‘å¤±è´¥ï¼Œè¯·é‡è¯•");
    }
  };

  // åˆ é™¤ç•™è¨€
  const handleDelete = async (messageId: number) => {
    if (!user) return;

    try {
      const { error } = await supabase
        .from("messages")
        .delete()
        .eq("id", messageId)
        .eq("user_id", user.id);

      if (error) throw error;

      // æ›´æ–°æœ¬åœ°çŠ¶æ€
      setMessages((prev) => prev.filter((msg) => msg.id !== messageId));

      // æ›´æ–°æ€»æ•°
      setTotal((prev) => prev - 1);
    } catch (error) {
      console.error("Error deleting message:", error);
      alert("åˆ é™¤å¤±è´¥ï¼Œè¯·é‡è¯•");
    }
  };

  const handleTogglePin = async (messageId: number) => {
    if (!user) return;

    // æ£€æŸ¥æ˜¯å¦æœ‰ç®¡ç†å‘˜æƒé™
    const isAdmin = user.email === "mydykitty@126.com"; // æ”¹æˆä½ çš„ç®¡ç†å‘˜é‚®ç®±

    if (!isAdmin) {
      alert("åªæœ‰ç®¡ç†å‘˜å¯ä»¥ç½®é¡¶ç•™è¨€");
      return;
    }

    try {
      // æ‰¾åˆ°å½“å‰æ¶ˆæ¯
      const targetMessage = messages.find((msg) => msg.id === messageId);
      if (!targetMessage) return;

      // æ›´æ–°æ•°æ®åº“
      const { error } = await supabase
        .from("messages")
        .update({ is_pinned: !targetMessage.is_pinned })
        .eq("id", messageId);

      if (error) throw error;

      // **å…³é”®ä¿®å¤ï¼šé‡æ–°æ’åºæ¶ˆæ¯åˆ—è¡¨**
      setMessages((prev) => {
        // å…ˆæ›´æ–°ç›®æ ‡æ¶ˆæ¯çš„ is_pinned çŠ¶æ€
        const updatedMessages = prev.map((msg) =>
          msg.id === messageId ? { ...msg, is_pinned: !msg.is_pinned } : msg,
        );

        // ç„¶åé‡æ–°æ’åºï¼šç½®é¡¶çš„åœ¨å‰ï¼ŒæŒ‰æ—¶é—´å€’åº
        return updatedMessages.sort((a, b) => {
          // å…ˆæŒ‰ç½®é¡¶çŠ¶æ€æ’åº
          if (a.is_pinned && !b.is_pinned) return -1;
          if (!a.is_pinned && b.is_pinned) return 1;
          // å†æŒ‰æ—¶é—´æ’åºï¼ˆæ–°çš„åœ¨å‰ï¼‰
          return (
            new Date(b.created_at).getTime() - new Date(a.created_at).getTime()
          );
        });
      });
    } catch (error) {
      console.error("Error toggling pin:", error);
      alert("æ“ä½œå¤±è´¥ï¼Œè¯·é‡è¯•");
      // å‡ºé”™æ—¶é‡æ–°è·å–æ•°æ®
      fetchMessages(1);
    }
  };

  return (
    <section className="py-8 px-6 bg-white dark:bg-gray-800 rounded-lg shadow-md transition-colors duration-300">
      <div className="flex justify-between items-center mb-6">
        <h2 className="text-2xl font-bold text-gray-900 dark:text-white">
          ğŸ’¬ è®¿å®¢ç•™è¨€æ¿
        </h2>
        <span className="text-sm text-gray-500 dark:text-gray-400">
          å…± {total} æ¡ç•™è¨€
        </span>
      </div>

      {/* ç•™è¨€è¡¨å• */}
      {user ? (
        <form onSubmit={submitMessage} className="mb-8">
          <div className="flex gap-3">
            <img
              src={user.user_metadata?.avatar_url}
              alt={user.user_metadata?.user_name}
              className="w-10 h-10 rounded-full flex-shrink-0"
            />
            <div className="flex-1">
              <textarea
                value={content}
                onChange={(e) => setContent(e.target.value)}
                placeholder="è¯´ç‚¹ä»€ä¹ˆ..."
                rows={2}
                className="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                required
              />
              <div className="flex justify-end mt-2">
                <button
                  type="submit"
                  disabled={loading}
                  className="px-6 py-2 bg-blue-500 hover:bg-blue-600 text-white font-medium rounded-lg transition-colors duration-300 disabled:opacity-50 disabled:cursor-not-allowed"
                >
                  {loading ? "å‘å¸ƒä¸­..." : "å‘å¸ƒç•™è¨€"}
                </button>
              </div>
            </div>
          </div>
        </form>
      ) : (
        <div className="mb-8 p-4 bg-blue-50 dark:bg-blue-900/20 text-blue-600 dark:text-blue-400 text-center rounded-lg">
          è¯·å…ˆç™»å½•åå†ç•™è¨€
        </div>
      )}

      {/* ğŸ”´ åœ¨è¿™é‡Œæ·»åŠ è¯äº‘å¼€å…³å’Œç»„ä»¶ */}
      <div className="mb-8">
        <button
          onClick={() => setShowWordCloud(!showWordCloud)}
          className="text-blue-500 hover:text-blue-600 mb-4 inline-flex items-center gap-2"
        >
          <span>{showWordCloud ? "ğŸ“–" : "â˜ï¸"}</span>
          <span>{showWordCloud ? "éšè—è¯äº‘" : "æ˜¾ç¤ºè¯äº‘"}</span>
        </button>

        {showWordCloud && <GuestbookWordCloud />}
      </div>

      {/* ç•™è¨€åˆ—è¡¨ - ä½¿ç”¨ GuestbookMessage ç»„ä»¶ */}
      <div className="space-y-4">
        {messages.map((msg) => (
          <GuestbookMessage
            key={msg.id}
            message={msg}
            currentUser={user}
            onLike={handleLike}
            onEdit={handleEdit}
            onDelete={handleDelete}
            onTogglePin={handleTogglePin} // æ–°å¢è¿™è¡Œ
          />
        ))}

        {/* åŠ è½½æ›´å¤š */}
        {hasMore && (
          <div className="text-center pt-4">
            <button
              onClick={loadMore}
              disabled={loading}
              className="px-6 py-2 bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-300 font-medium rounded-lg transition-colors duration-300 disabled:opacity-50"
            >
              {loading ? "åŠ è½½ä¸­..." : "åŠ è½½æ›´å¤šç•™è¨€"}
            </button>
          </div>
        )}

        {messages.length === 0 && !loading && (
          <p className="text-center text-gray-500 dark:text-gray-400 py-8">
            è¿˜æ²¡æœ‰ç•™è¨€ï¼Œæ¥å½“ç¬¬ä¸€ä¸ªè®¿å®¢å§ï¼ âœ¨
          </p>
        )}
      </div>
    </section>
  );
};

export default Guestbook;


===== src/components/GuestbookMessage.tsx =====
// src/components/GuestbookMessage.tsx
import { useState, useEffect } from "react";
import { supabase } from "../lib/supabase";
import type { MessageWithLike } from "../types";
import type { User } from "@supabase/supabase-js";
import MessageReactions from "./MessageReactions"; // å¯¼å…¥è¡¨æƒ…ç»„ä»¶

interface GuestbookMessageProps {
  message: MessageWithLike;
  currentUser: User | null;
  onLike: (id: number) => void;
  onEdit: (id: number, content: string) => Promise<void>;
  onDelete: (id: number) => Promise<void>;
  onTogglePin: (id: number) => Promise<void>;
}

const GuestbookMessage = ({
  message,
  currentUser,
  onLike,
  onEdit,
  onDelete,
  onTogglePin,
}: GuestbookMessageProps) => {
  const [isEditing, setIsEditing] = useState(false);
  const [editContent, setEditContent] = useState(message.content);
  const [isSubmitting, setIsSubmitting] = useState(false);

  // è¡¨æƒ…ååº”ç›¸å…³çŠ¶æ€
  const [reactions, setReactions] = useState<{ [key: string]: number }>({});
  const [userReactions, setUserReactions] = useState<string[]>([]);

  const isOwnMessage = currentUser?.id === message.user_id;

  // è·å–è¡¨æƒ…æ•°æ®
  const fetchReactions = async () => {
    const { data } = await supabase
      .from("message_reactions")
      .select("reaction, user_id")
      .eq("message_id", message.id);

    if (data) {
      const counts: { [key: string]: number } = {};
      const userEmojis: string[] = [];

      data.forEach((item) => {
        counts[item.reaction] = (counts[item.reaction] || 0) + 1;
        if (currentUser && item.user_id === currentUser.id) {
          userEmojis.push(item.reaction);
        }
      });

      setReactions(counts);
      setUserReactions(userEmojis);
    }
  };

  // åŠ è½½æ—¶è·å–è¡¨æƒ…
  useEffect(() => {
    fetchReactions();
  }, [message.id, currentUser]);

  const handleEdit = async () => {
    if (!editContent.trim() || editContent === message.content) {
      setIsEditing(false);
      return;
    }

    setIsSubmitting(true);
    try {
      await onEdit(message.id, editContent.trim());
      setIsEditing(false);
    } finally {
      setIsSubmitting(false);
    }
  };

  const handleDelete = async () => {
    if (window.confirm("ç¡®å®šè¦åˆ é™¤è¿™æ¡ç•™è¨€å—ï¼Ÿ")) {
      await onDelete(message.id);
    }
  };

  const isAdmin = currentUser?.email === "mydykitty@126.com"; // æ”¹æˆä½ çš„ç®¡ç†å‘˜é‚®ç®±

  return (
    <div className="flex gap-3 p-4 bg-gray-50 dark:bg-gray-700/50 rounded-lg border border-gray-200 dark:border-gray-600">
      {/* å¤´åƒ */}
      <img
        src={message.avatar_url || `https://github.com/${message.name}.png`}
        alt={message.name}
        className="w-10 h-10 rounded-full flex-shrink-0"
        onError={(e) => {
          e.currentTarget.src = `https://ui-avatars.com/api/?name=${message.name}&background=random`;
        }}
      />

      {/* å†…å®¹åŒºåŸŸ */}
      <div className="flex-1 min-w-0">
        {/* å¤´éƒ¨ï¼šç”¨æˆ·å + æ—¶é—´ + æ“ä½œæŒ‰é’® */}
        <div className="flex justify-between items-start gap-2">
          <div className="flex items-center gap-2">
            <div className="flex items-center gap-2">
              <span className="font-medium text-blue-600 dark:text-blue-400">
                {message.name}
              </span>
              {message.is_pinned && (
                <span className="text-yellow-500" title="ç½®é¡¶ç•™è¨€">
                  ğŸ“Œ
                </span>
              )}
            </div>
            {isOwnMessage && (
              <span className="text-xs bg-green-100 dark:bg-green-900/30 text-green-600 dark:text-green-400 px-2 py-0.5 rounded-full">
                æˆ‘
              </span>
            )}
          </div>

          <div className="flex items-center gap-2">
            <span className="text-xs text-gray-500 dark:text-gray-400">
              {new Date(message.created_at).toLocaleString("zh-CN")}
            </span>

            {/* ç¼–è¾‘/åˆ é™¤æŒ‰é’® - åªæœ‰è‡ªå·±çš„ç•™è¨€æ‰æ˜¾ç¤º */}
            {!isEditing && (
              <div className="flex gap-1">
                {/* ç½®é¡¶æŒ‰é’® - ç®¡ç†å‘˜å¯è§ï¼ˆå¯ä»¥æ“ä½œæ‰€æœ‰ç•™è¨€ï¼‰ */}
                {isAdmin && (
                  <button
                    onClick={() => onTogglePin(message.id)}
                    className={`transition-colors p-1 ${
                      message.is_pinned
                        ? "text-yellow-500 hover:text-yellow-600"
                        : "text-gray-400 hover:text-yellow-500"
                    }`}
                    title={message.is_pinned ? "å–æ¶ˆç½®é¡¶" : "ç½®é¡¶ç•™è¨€"}
                  >
                    ğŸ“Œ
                  </button>
                )}

                {/* ç¼–è¾‘/åˆ é™¤æŒ‰é’® - åªæœ‰è‡ªå·±çš„ç•™è¨€æ‰æ˜¾ç¤º */}
                {isOwnMessage && (
                  <>
                    <button
                      onClick={() => setIsEditing(true)}
                      className="text-gray-400 hover:text-blue-500 transition-colors p-1"
                      title="ç¼–è¾‘"
                    >
                      <svg
                        className="w-4 h-4"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                      >
                        <path
                          strokeLinecap="round"
                          strokeLinejoin="round"
                          strokeWidth={2}
                          d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"
                        />
                      </svg>
                    </button>
                    <button
                      onClick={handleDelete}
                      className="text-gray-400 hover:text-red-500 transition-colors p-1"
                      title="åˆ é™¤"
                    >
                      <svg
                        className="w-4 h-4"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                      >
                        <path
                          strokeLinecap="round"
                          strokeLinejoin="round"
                          strokeWidth={2}
                          d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"
                        />
                      </svg>
                    </button>
                  </>
                )}
              </div>
            )}
          </div>
        </div>

        {/* å†…å®¹åŒºåŸŸï¼šç¼–è¾‘æ¨¡å¼æˆ–æ˜¾ç¤ºæ¨¡å¼ */}
        {isEditing ? (
          <div className="mt-2">
            <textarea
              value={editContent}
              onChange={(e) => setEditContent(e.target.value)}
              className="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-sm"
              rows={3}
              autoFocus
              disabled={isSubmitting}
            />
            <div className="flex justify-end gap-2 mt-2">
              <button
                onClick={() => {
                  setIsEditing(false);
                  setEditContent(message.content);
                }}
                className="px-3 py-1 text-sm bg-gray-200 dark:bg-gray-600 hover:bg-gray-300 dark:hover:bg-gray-500 rounded transition-colors"
                disabled={isSubmitting}
              >
                å–æ¶ˆ
              </button>
              <button
                onClick={handleEdit}
                disabled={isSubmitting || !editContent.trim()}
                className="px-3 py-1 text-sm bg-blue-500 hover:bg-blue-600 text-white rounded transition-colors disabled:opacity-50"
              >
                {isSubmitting ? "ä¿å­˜ä¸­..." : "ä¿å­˜"}
              </button>
            </div>
          </div>
        ) : (
          <p className="mt-1 text-gray-700 dark:text-gray-300 break-words whitespace-pre-wrap">
            {message.content}
          </p>
        )}

        {/* ç‚¹èµæŒ‰é’® */}
        <div className="mt-2 flex items-center gap-4">
          <button
            onClick={() => onLike(message.id)}
            disabled={!currentUser}
            className={`flex items-center gap-1 text-sm transition-colors ${
              !currentUser
                ? "opacity-50 cursor-not-allowed"
                : "hover:text-blue-500"
            } ${
              message.liked_by_user
                ? "text-blue-500"
                : "text-gray-500 dark:text-gray-400"
            }`}
          >
            <svg
              className={`w-5 h-5 ${message.liked_by_user ? "fill-current" : ""}`}
              fill={message.liked_by_user ? "currentColor" : "none"}
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                strokeLinecap="round"
                strokeLinejoin="round"
                strokeWidth={2}
                d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"
              />
            </svg>
            <span>{message.likes_count || 0}</span>
          </button>
        </div>

        {/* ä½¿ç”¨ MessageReactions ç»„ä»¶ */}
        <MessageReactions
          messageId={message.id}
          reactions={reactions}
          userReactions={userReactions}
          onReactionUpdate={fetchReactions}
        />
      </div>
    </div>
  );
};

export default GuestbookMessage;


===== src/components/GuestbookWordCloud.tsx =====
import React, { useState, useEffect, useRef } from "react";
import * as d3 from "d3";
import cloud from "d3-cloud";
import { supabase } from "../lib/supabase";

interface WordData {
  text: string;
  value: number;
}

const GuestbookWordCloud: React.FC = () => {
  const [words, setWords] = useState<WordData[]>([]);
  const [loading, setLoading] = useState(true);
  const [timeRange, setTimeRange] = useState<"week" | "month" | "all">("all");
  const containerRef = useRef<HTMLDivElement>(null);

  useEffect(() => {
    fetchMessages();
  }, [timeRange]);

  useEffect(() => {
    if (words.length > 0 && containerRef.current) {
      renderWordCloud();
    }
  }, [words]);

  const fetchMessages = async () => {
    setLoading(true);

    let query = supabase.from("messages").select("content");

    const now = new Date();
    if (timeRange === "week") {
      const weekAgo = new Date(now.setDate(now.getDate() - 7));
      query = query.gte("created_at", weekAgo.toISOString());
    } else if (timeRange === "month") {
      const monthAgo = new Date(now.setMonth(now.getMonth() - 1));
      query = query.gte("created_at", monthAgo.toISOString());
    }

    const { data } = await query;

    if (data && data.length > 0) {
      // è¯é¢‘ç»Ÿè®¡
      const wordCount: Record<string, number> = {};

      data.forEach((msg) => {
        // æŒ‰ä¸­æ–‡å’Œè‹±æ–‡æ ‡ç‚¹åˆ†å‰²
        const words = msg.content.split(
          /[\sï¼Œ,ã€‚.ï¼!ï¼Ÿ?ï¼›;ï¼š:ã€/\\ï¼ˆï¼‰()ã€ã€‘\[\]{}]+/,
        );
        words.forEach((word: string) => {
          const trimmed = word.trim();
          if (trimmed.length > 1) {
            // åªç»Ÿè®¡é•¿åº¦å¤§äº1çš„è¯
            wordCount[trimmed] = (wordCount[trimmed] || 0) + 1;
          }
        });
      });

      const wordList = Object.entries(wordCount)
        .map(([text, value]) => ({ text, value }))
        .sort((a, b) => b.value - a.value)
        .slice(0, 50); // å–å‰50ä¸ªè¯

      setWords(wordList);
    } else {
      setWords([]);
    }

    setLoading(false);
  };

  const renderWordCloud = () => {
    if (!containerRef.current || words.length === 0) return;

    const container = containerRef.current;
    const width = container.clientWidth;
    const height = 400;

    // æ¸…ç©ºå®¹å™¨
    container.innerHTML = "";

    // è®¡ç®—å­—ä½“å¤§å°èŒƒå›´
    const maxValue = Math.max(...words.map((w) => w.value));
    const minValue = Math.min(...words.map((w) => w.value));

    // å‡†å¤‡è¯äº‘æ•°æ®ï¼šæ ¹æ®è¯é¢‘è®¡ç®—å­—ä½“å¤§å° (20-80px)
    const wordData = words.map((w) => ({
      text: w.text,
      size:
        minValue === maxValue
          ? 40
          : 20 + ((w.value - minValue) / (maxValue - minValue)) * 60,
    }));

    // åˆ›å»ºè¯äº‘å¸ƒå±€
    const layout = cloud()
      .size([width, height])
      .words(wordData)
      .padding(3) // è¯ä¸è¯ä¹‹é—´çš„é—´è·
      .rotate(() => (Math.random() > 0.5 ? 0 : 30)) // éšæœºæ—‹è½¬0æˆ–30åº¦
      .font("sans-serif")
      .fontSize((d) => d.size!)
      .on("end", draw);

    layout.start();

    // ç»˜åˆ¶å‡½æ•°
    function draw(words: cloud.Word[]) {
      // åˆ›å»ºSVG
      const svg = d3
        .select(container)
        .append("svg")
        .attr("width", width)
        .attr("height", height)
        .append("g")
        .attr("transform", `translate(${width / 2},${height / 2})`);

      // æ·»åŠ è¯äº‘æ–‡å­—
      svg
        .selectAll("text")
        .data(words)
        .enter()
        .append("text")
        .style("font-size", (d) => `${d.size}px`)
        .style("font-family", "sans-serif")
        .style("font-weight", "bold")
        .style("fill", (_d, i) => {
          // ä½¿ç”¨ D3 çš„é¢œè‰²æ–¹æ¡ˆ
          const colors = [
            "#3b82f6",
            "#ef4444",
            "#10b981",
            "#f59e0b",
            "#8b5cf6",
            "#ec4899",
            "#06b6d4",
            "#f97316",
          ];
          return colors[i % colors.length];
        })
        .style("opacity", 0.8)
        .style("cursor", "pointer")
        .attr("text-anchor", "middle")
        .attr(
          "transform",
          (d) => `translate(${d.x},${d.y}) rotate(${d.rotate})`,
        )
        .text((d) => d.text!)
        .on("mouseover", function () {
          d3.select(this)
            .style("opacity", 1)
            .style("font-size", (d) => `${(d as any).size * 1.1}px`);
        })
        .on("mouseout", function () {
          d3.select(this)
            .style("opacity", 0.8)
            .style("font-size", (d) => `${(d as any).size}px`);
        })
        .on("click", (d) => {
          console.log("ç‚¹å‡»è¯:", d.text);
          // å¯ä»¥æ·»åŠ ç‚¹å‡»æœç´¢åŠŸèƒ½
          alert(`ä½ ç‚¹å‡»äº†: ${d.text}`);
        });
    }
  };

  // çª—å£å¤§å°å˜åŒ–æ—¶é‡æ–°æ¸²æŸ“
  useEffect(() => {
    const handleResize = () => {
      if (words.length > 0) {
        renderWordCloud();
      }
    };

    window.addEventListener("resize", handleResize);
    return () => window.removeEventListener("resize", handleResize);
  }, [words]);

  if (loading) {
    return (
      <div className="flex justify-center items-center h-64">
        <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500"></div>
      </div>
    );
  }

  return (
    <div className="bg-white dark:bg-gray-800 rounded-lg p-6 shadow-lg">
      {/* æ ‡é¢˜å’Œç­›é€‰ */}
      <div className="flex justify-between items-center mb-6">
        <h2 className="text-2xl font-bold text-gray-900 dark:text-white">
          â˜ï¸ ç•™è¨€è¯äº‘
        </h2>

        <div className="flex gap-2">
          <button
            onClick={() => setTimeRange("week")}
            className={`px-3 py-1 rounded-lg text-sm transition-colors ${
              timeRange === "week"
                ? "bg-blue-500 text-white"
                : "bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-600"
            }`}
          >
            è¿‘ä¸€å‘¨
          </button>
          <button
            onClick={() => setTimeRange("month")}
            className={`px-3 py-1 rounded-lg text-sm transition-colors ${
              timeRange === "month"
                ? "bg-blue-500 text-white"
                : "bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-600"
            }`}
          >
            è¿‘ä¸€æœˆ
          </button>
          <button
            onClick={() => setTimeRange("all")}
            className={`px-3 py-1 rounded-lg text-sm transition-colors ${
              timeRange === "all"
                ? "bg-blue-500 text-white"
                : "bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-600"
            }`}
          >
            å…¨éƒ¨
          </button>
        </div>
      </div>

      {/* ç»Ÿè®¡ä¿¡æ¯ */}
      {words.length > 0 && (
        <div className="mb-4 text-sm text-gray-500 dark:text-gray-400">
          å…± {words.length} ä¸ªçƒ­é—¨è¯ï¼Œç‚¹å‡»è¯å¯æŸ¥çœ‹è¯¦æƒ…
        </div>
      )}

      {/* è¯äº‘å®¹å™¨ */}
      {words.length > 0 ? (
        <div
          ref={containerRef}
          className="w-full h-[400px] border border-gray-200 dark:border-gray-700 rounded-lg bg-white dark:bg-gray-800"
        />
      ) : (
        <div className="h-[400px] flex items-center justify-center text-gray-500 border border-gray-200 dark:border-gray-700 rounded-lg">
          æš‚æ— ç•™è¨€æ•°æ®
        </div>
      )}

      {/* çƒ­é—¨è¯åˆ—è¡¨ */}
      {words.length > 0 && (
        <div className="mt-6">
          <h3 className="text-lg font-semibold mb-3">çƒ­é—¨è¯ TOP 10</h3>
          <div className="grid grid-cols-2 md:grid-cols-5 gap-2">
            {words.slice(0, 10).map((word) => (
              <div
                key={word.text}
                className="flex items-center justify-between p-2 bg-gray-50 dark:bg-gray-700 rounded"
              >
                <span className="font-medium">{word.text}</span>
                <span className="text-sm text-gray-500">{word.value}æ¬¡</span>
              </div>
            ))}
          </div>
        </div>
      )}
    </div>
  );
};

export default GuestbookWordCloud;


===== src/components/Header.tsx =====
import React from "react";
import { Link } from "react-router-dom";
import { useAuthStore } from "../store/authStore";
import Typewriter from "./Typewriter";
import LanguageSwitcher from "./LanguageSwitcher";
import { useTranslation } from "react-i18next";
import LazyImage from "./common/LazyImage";

interface HeaderProps {
  name: string;
  title: string;
}

const Header: React.FC<HeaderProps> = ({}) => {
  const { user } = useAuthStore();
  const { t } = useTranslation();

  return (
    <header className="text-center py-8 bg-white dark:bg-gray-900 transition-colors duration-300 relative">
      {/* å¯¼èˆªæ  - è°ƒæ•´ä½ç½®ï¼Œä¸å†ä½¿ç”¨ absolute */}
      <div className="flex justify-end items-center gap-3 mb-4">
        <LanguageSwitcher />

        <Link
          to="/blog"
          className="text-gray-600 dark:text-gray-400 hover:text-blue-500 dark:hover:text-blue-400 transition-colors px-3 py-1 text-sm"
        >
          {t("common.blog")}
        </Link>

        {user && (
          <Link
            to="/profile"
            className="flex items-center gap-2 text-gray-600 dark:text-gray-400 hover:text-blue-500 dark:hover:text-blue-400 transition-colors px-3 py-1 text-sm"
          >
            <LazyImage
              src={user.user_metadata?.avatar_url}
              alt={user.user_metadata?.user_name}
              className="w-6 h-6 rounded-full"
              width={24}
              height={24}
            />
            <span>{t("common.profile")}</span>
          </Link>
        )}
      </div>

      {/* å§“åå’Œæ ‡é¢˜ */}
      <div className="mt-4">
        {" "}
        {/* æ·»åŠ ä¸Šè¾¹è·ï¼Œä¸å¯¼èˆªæ åˆ†å¼€ */}
        <h1 className="text-4xl font-bold text-gray-900 dark:text-white mb-2">
          {t("header.name")}
        </h1>
        <h3 className="text-xl text-gray-600 dark:text-gray-300">
          <Typewriter
            texts={[
              t("header.title"),
              "React çˆ±å¥½è€…",
              "TypeScript ç©å®¶",
              "UI è®¾è®¡æ§",
            ]}
          />
        </h3>
      </div>
    </header>
  );
};

export default Header;


===== src/components/LanguageSwitcher.tsx =====
import React from "react";
import { useTranslation } from "react-i18next";

const LanguageSwitcher: React.FC = () => {
  const { i18n } = useTranslation();

  const languages = [
    { code: "zh", name: "ä¸­æ–‡", flag: "ğŸ‡¨ğŸ‡³" },
    { code: "en", name: "English", flag: "ğŸ‡¬ğŸ‡§" },
  ];

  return (
    <div className="relative">
      <select
        value={i18n.language}
        onChange={(e) => i18n.changeLanguage(e.target.value)}
        className="appearance-none bg-gray-100 dark:bg-gray-800 border border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white rounded-lg px-4 py-2 pr-8 cursor-pointer hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors"
      >
        {languages.map((lang) => (
          <option key={lang.code} value={lang.code}>
            {lang.flag} {lang.name}
          </option>
        ))}
      </select>
      <div className="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700 dark:text-gray-300">
        â–¼
      </div>
    </div>
  );
};

export default LanguageSwitcher;


===== src/components/MessageReactions.tsx =====
// src/components/MessageReactions.tsx
import React, { useState } from "react";
import { supabase } from "../lib/supabase";
import { useAuthStore } from "../store/authStore";

interface MessageReactionsProps {
  messageId: number;
  reactions: { [key: string]: number };
  userReactions: string[];
  onReactionUpdate: () => void;
}

const REACTION_EMOJIS = ["ğŸ‘", "â¤ï¸", "ğŸ˜‚", "ğŸ˜®", "ğŸ˜¢", "ğŸ˜¡"];

const MessageReactions: React.FC<MessageReactionsProps> = ({
  messageId,
  reactions = {},
  userReactions = [],
  onReactionUpdate,
}) => {
  const user = useAuthStore((state) => state.user);
  const [loading, setLoading] = useState<string | null>(null);

  const handleReaction = async (emoji: string) => {
    if (!user) {
      alert("è¯·å…ˆç™»å½•åå†æ·»åŠ è¡¨æƒ…");
      return;
    }

    setLoading(emoji);

    try {
      const hasReaction = userReactions.includes(emoji);

      if (hasReaction) {
        // å–æ¶ˆè¡¨æƒ…
        await supabase
          .from("message_reactions")
          .delete()
          .eq("message_id", messageId)
          .eq("user_id", user.id)
          .eq("reaction", emoji);
      } else {
        // æ·»åŠ è¡¨æƒ…
        await supabase.from("message_reactions").insert({
          message_id: messageId,
          user_id: user.id,
          reaction: emoji,
        });
      }

      // é€šçŸ¥çˆ¶ç»„ä»¶æ›´æ–°
      onReactionUpdate();
    } catch (error) {
      console.error("æ“ä½œå¤±è´¥:", error);
    } finally {
      setLoading(null);
    }
  };

  return (
    <div className="flex flex-wrap items-center gap-2 mt-2">
      {REACTION_EMOJIS.map((emoji) => {
        const count = reactions[emoji] || 0;
        const isActive = userReactions.includes(emoji);
        const isLoading = loading === emoji;

        return (
          <button
            key={emoji}
            onClick={() => handleReaction(emoji)}
            disabled={!user || isLoading}
            className={`
              inline-flex items-center gap-1 px-2 py-1 rounded-full text-sm
              transition-all duration-200 border
              ${
                isActive
                  ? "bg-blue-100 dark:bg-blue-900 border-blue-300 dark:border-blue-700"
                  : "bg-gray-100 dark:bg-gray-800 border-gray-200 dark:border-gray-700 hover:bg-gray-200 dark:hover:bg-gray-700"
              }
              ${!user ? "opacity-50 cursor-not-allowed" : "cursor-pointer"}
            `}
            title={isActive ? "å–æ¶ˆååº”" : `æ·»åŠ  ${emoji}`}
          >
            <span className="text-base">{emoji}</span>
            {count > 0 && (
              <span
                className={`text-xs font-medium ${isActive ? "text-blue-600 dark:text-blue-300" : "text-gray-600 dark:text-gray-400"}`}
              >
                {count}
              </span>
            )}
            {isLoading && (
              <span className="w-3 h-3 border-2 border-blue-500 border-t-transparent rounded-full animate-spin" />
            )}
          </button>
        );
      })}
    </div>
  );
};

export default MessageReactions;


===== src/components/Projects.tsx =====
import React, { useState } from "react";
import type { Project } from "../types";

interface ProjectsProps {
  projects: Project[];
}

const Projects: React.FC<ProjectsProps> = ({ projects }) => {
  const [filter, setFilter] = useState("all");

  // è·å–æ‰€æœ‰åˆ†ç±»ï¼ˆå»é‡ï¼‰
  const categories = [
    "all",
    ...new Set(
      projects
        .map((p) => p.category)
        .filter((c): c is string => c !== undefined), // åªä¿ç•™ string
    ),
  ];

  // ç­›é€‰é¡¹ç›®
  const filteredProjects =
    filter === "all" ? projects : projects.filter((p) => p.category === filter);

  return (
    <section className="py-8 bg-white dark:bg-gray-800 rounded-lg shadow-md transition-colors duration-300">
      <h2 className="text-2xl font-bold text-gray-900 dark:text-white mb-6 text-center">
        é¡¹ç›®
      </h2>

      {/* ç­›é€‰æŒ‰é’®ç»„ */}
      <div className="flex flex-wrap justify-center gap-2 mb-6">
        {categories.map((category) => (
          <button
            key={category}
            onClick={() => setFilter(category)}
            className={`
              px-4 py-2 rounded-full text-sm font-medium
              transition-all duration-300
              ${
                filter === category
                  ? "bg-blue-500 text-white shadow-md"
                  : "bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-600"
              }
            `}
          >
            {category === "all" ? "å…¨éƒ¨" : category}
          </button>
        ))}
      </div>

      {/* é¡¹ç›®åˆ—è¡¨ */}
      <div className="space-y-4">
        {filteredProjects.map((project, index) => (
          <div
            key={index}
            className="p-4 border border-gray-200 dark:border-gray-600 rounded-lg hover:shadow-lg transition-shadow"
          >
            <h3 className="text-xl font-semibold text-gray-800 dark:text-gray-200 mb-2">
              {project.name}
            </h3>
            <p className="text-gray-600 dark:text-gray-400 mb-2">
              {project.description}
            </p>

            {/* æ ‡ç­¾äº‘ */}
            {project.tags && (
              <div className="flex flex-wrap gap-2 mb-3">
                {project.tags.map((tag) => (
                  <span
                    key={tag}
                    className="px-2 py-1 text-xs bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-400 rounded"
                  >
                    {tag}
                  </span>
                ))}
              </div>
            )}

            {project.link && project.link !== "#" && (
              <a
                href={project.link}
                className="text-blue-600 dark:text-blue-400 hover:underline"
              >
                æŸ¥çœ‹é¡¹ç›® â†’
              </a>
            )}
          </div>
        ))}
      </div>

      {/* ç©ºçŠ¶æ€ */}
      {filteredProjects.length === 0 && (
        <p className="text-center text-gray-500 dark:text-gray-400 py-8">
          æš‚æ— è¯¥åˆ†ç±»çš„é¡¹ç›®
        </p>
      )}
    </section>
  );
};

export default Projects;


===== src/components/ScrollReveal.tsx =====
import { useInView } from "react-intersection-observer";
import type { FC, ReactNode } from "react";

interface ScrollRevealProps {
  children: ReactNode;
}

const ScrollReveal: FC<ScrollRevealProps> = ({ children }) => {
  const { ref, inView } = useInView({
    triggerOnce: true, // åªè§¦å‘ä¸€æ¬¡
    threshold: 0.2, // 20% å‡ºç°åœ¨è§†å£æ‰è§¦å‘
  });

  return (
    <div ref={ref} className={`scroll-section ${inView ? "show" : ""}`}>
      {children}
    </div>
  );
};

export default ScrollReveal;


===== src/components/Skills.tsx =====
import type { FC } from "react";
import { useEffect, useState } from "react";
import { skills } from "../data/skills";
import type { Skill } from "../data/skills";
import { useInView } from "react-intersection-observer";
import SkillsHeatmap from "./SkillsHeatmap"; // å¯¼å…¥çƒ­åŠ›å›¾ç»„ä»¶

const Skills: FC = () => {
  // ç›‘å¬æ•´ä¸ª Skills åŒºå—æ˜¯å¦è¿›å…¥è§†å£
  const { ref, inView } = useInView({ triggerOnce: true });

  // è§†å›¾æ¨¡å¼åˆ‡æ¢
  const [viewMode, setViewMode] = useState<"list" | "heatmap">("heatmap");

  // åˆå§‹åŒ–æ¯ä¸ªæŠ€èƒ½ç­‰çº§ä¸º 0
  const [animatedLevels, setAnimatedLevels] = useState<Skill[]>(
    skills.map((s) => ({ ...s, level: 0 })),
  );

  // ç»„ä»¶æŒ‚è½½åï¼Œå¦‚æœ inView ä¸º trueï¼Œä¾æ¬¡åŠ¨ç”»æ¯ä¸ªæŠ€èƒ½æ¡
  useEffect(() => {
    if (!inView) return;

    skills.forEach((skill, idx) => {
      setTimeout(() => {
        setAnimatedLevels((prev) => {
          const copy = [...prev];
          copy[idx] = { ...copy[idx], level: skill.level };
          return copy;
        });
      }, idx * 200); // æ¯ä¸ªæŠ€èƒ½æ¡å»¶è¿Ÿ 200ms åŠ¨ç”»
    });
  }, [inView]);

  return (
    <section
      ref={ref}
      className="max-w-4xl mx-auto p-6 bg-white dark:bg-gray-800 rounded-lg transition-colors duration-300"
    >
      {/* æ ‡é¢˜å’Œè§†å›¾åˆ‡æ¢æŒ‰é’® */}
      <div className="flex justify-between items-center mb-6">
        <h2 className="text-2xl font-bold">âš¡ æŠ€èƒ½æ ˆ</h2>
        <div className="flex gap-2">
          <button
            onClick={() => setViewMode("list")}
            className={`px-3 py-1 rounded-lg text-sm transition-colors ${
              viewMode === "list"
                ? "bg-blue-500 text-white"
                : "bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-600"
            }`}
          >
            åˆ—è¡¨è§†å›¾
          </button>
          <button
            onClick={() => setViewMode("heatmap")}
            className={`px-3 py-1 rounded-lg text-sm transition-colors ${
              viewMode === "heatmap"
                ? "bg-blue-500 text-white"
                : "bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-600"
            }`}
          >
            çƒ­åŠ›å›¾
          </button>
        </div>
      </div>

      {/* æ ¹æ®è§†å›¾æ¨¡å¼æ˜¾ç¤ºä¸åŒå†…å®¹ */}
      {viewMode === "list" ? (
        <div className="space-y-4">
          {animatedLevels.map((skill) => (
            <div key={skill.name}>
              <div className="flex justify-between mb-1">
                <span className="font-medium">{skill.name}</span>
                <span className="text-sm">{skill.level}%</span>
              </div>
              <div className="w-full bg-gray-200 h-4 rounded overflow-hidden shadow-inner">
                <div
                  className="bg-blue-500 h-4 rounded transition-all duration-1000 ease-out shadow-md"
                  style={{ width: `${skill.level}%` }}
                ></div>
              </div>
            </div>
          ))}
        </div>
      ) : (
        <SkillsHeatmap />
      )}
    </section>
  );
};

export default Skills;


===== src/components/SkillsHeatmap.tsx =====
import React, { useEffect, useState } from "react";
import {
  Radar,
  RadarChart,
  PolarGrid,
  PolarAngleAxis,
  PolarRadiusAxis,
  BarChart,
  Bar,
  XAxis,
  YAxis,
  CartesianGrid,
  Tooltip,
  ResponsiveContainer,
} from "recharts";
import { skills } from "../data/skills";

interface SkillData {
  subject: string;
  value: number;
  fullMark: number;
}

const SkillsHeatmap: React.FC = () => {
  const [data, setData] = useState<SkillData[]>([]);
  const [viewType, setViewType] = useState<"radar" | "bar">("radar");

  useEffect(() => {
    // è½¬æ¢æŠ€èƒ½æ•°æ®æ ¼å¼
    const chartData = skills.map((skill) => ({
      subject: skill.name,
      value: skill.level,
      fullMark: 100,
    }));
    setData(chartData);
  }, []);

  // è®¡ç®—å¹³å‡ç†Ÿç»ƒåº¦
  const averageLevel = Math.round(
    skills.reduce((sum, skill) => sum + skill.level, 0) / skills.length,
  );

  // æœ€é«˜æŠ€èƒ½
  const topSkill = skills.reduce(
    (max, skill) => (skill.level > max.level ? skill : max),
    skills[0],
  );

  return (
    <div className="bg-white dark:bg-gray-800 rounded-lg p-6 shadow-lg">
      {/* æ ‡é¢˜å’Œç»Ÿè®¡ */}
      <div className="flex justify-between items-center mb-6">
        <h2 className="text-2xl font-bold text-gray-900 dark:text-white">
          ğŸ”¥ æŠ€èƒ½çƒ­åŠ›å›¾
        </h2>
        <div className="flex gap-2">
          <button
            onClick={() => setViewType("radar")}
            className={`px-3 py-1 rounded-lg text-sm transition-colors ${
              viewType === "radar"
                ? "bg-blue-500 text-white"
                : "bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-400"
            }`}
          >
            é›·è¾¾å›¾
          </button>
          <button
            onClick={() => setViewType("bar")}
            className={`px-3 py-1 rounded-lg text-sm transition-colors ${
              viewType === "bar"
                ? "bg-blue-500 text-white"
                : "bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-400"
            }`}
          >
            æŸ±çŠ¶å›¾
          </button>
        </div>
      </div>

      {/* ç»Ÿè®¡å¡ç‰‡ */}
      <div className="grid grid-cols-2 gap-4 mb-6">
        <div className="bg-blue-50 dark:bg-blue-900/20 p-4 rounded-lg">
          <div className="text-sm text-blue-600 dark:text-blue-400">
            å¹³å‡ç†Ÿç»ƒåº¦
          </div>
          <div className="text-2xl font-bold text-blue-700 dark:text-blue-300">
            {averageLevel}%
          </div>
        </div>
        <div className="bg-green-50 dark:bg-green-900/20 p-4 rounded-lg">
          <div className="text-sm text-green-600 dark:text-green-400">
            æœ€å¼ºæŠ€èƒ½
          </div>
          <div className="text-2xl font-bold text-green-700 dark:text-green-300">
            {topSkill.name}
          </div>
          <div className="text-xs text-green-600 dark:text-green-400">
            {topSkill.level}%
          </div>
        </div>
      </div>

      {/* å›¾è¡¨åŒºåŸŸ */}
      <div className="h-80 w-full">
        <ResponsiveContainer width="100%" height="100%">
          {viewType === "radar" ? (
            <RadarChart cx="50%" cy="50%" outerRadius="80%" data={data}>
              <PolarGrid
                stroke={
                  document.documentElement.classList.contains("dark")
                    ? "#374151"
                    : "#e5e7eb"
                }
              />
              <PolarAngleAxis
                dataKey="subject"
                tick={{
                  fill: document.documentElement.classList.contains("dark")
                    ? "#9ca3af"
                    : "#4b5563",
                  fontSize: 12,
                }}
              />
              <PolarRadiusAxis
                angle={30}
                domain={[0, 100]}
                tick={{
                  fill: document.documentElement.classList.contains("dark")
                    ? "#9ca3af"
                    : "#4b5563",
                  fontSize: 10,
                }}
              />
              <Radar
                name="æŠ€èƒ½ç†Ÿç»ƒåº¦"
                dataKey="value"
                stroke="#3b82f6"
                fill="#3b82f6"
                fillOpacity={0.6}
              />
              <Tooltip
                contentStyle={{
                  backgroundColor: document.documentElement.classList.contains(
                    "dark",
                  )
                    ? "#1f2937"
                    : "#ffffff",
                  borderColor: document.documentElement.classList.contains(
                    "dark",
                  )
                    ? "#374151"
                    : "#e5e7eb",
                  color: document.documentElement.classList.contains("dark")
                    ? "#ffffff"
                    : "#000000",
                }}
              />
            </RadarChart>
          ) : (
            // ğŸ”´ çœŸæ­£çš„æŸ±çŠ¶å›¾
            <BarChart
              data={data}
              layout="vertical"
              margin={{ top: 5, right: 30, left: 60, bottom: 5 }}
            >
              <CartesianGrid
                strokeDasharray="3 3"
                stroke={
                  document.documentElement.classList.contains("dark")
                    ? "#374151"
                    : "#e5e7eb"
                }
              />
              <XAxis
                type="number"
                domain={[0, 100]}
                tick={{
                  fill: document.documentElement.classList.contains("dark")
                    ? "#9ca3af"
                    : "#4b5563",
                  fontSize: 12,
                }}
              />
              <YAxis
                type="category"
                dataKey="subject"
                width={10}
                tick={{
                  fill: document.documentElement.classList.contains("dark")
                    ? "#9ca3af"
                    : "#4b5563",
                  fontSize: 12,
                }}
              />
              <Tooltip
                contentStyle={{
                  backgroundColor: document.documentElement.classList.contains(
                    "dark",
                  )
                    ? "#1f2937"
                    : "#ffffff",
                  borderColor: document.documentElement.classList.contains(
                    "dark",
                  )
                    ? "#374151"
                    : "#e5e7eb",
                  color: document.documentElement.classList.contains("dark")
                    ? "#ffffff"
                    : "#000000",
                }}
                formatter={(value: number | undefined) => {
                  if (value === undefined || value === null) {
                    return ["0%", "ç†Ÿç»ƒåº¦"]; // æˆ–è€…è¿”å› ["-", "ç†Ÿç»ƒåº¦"]
                  }
                  return [`${value}%`, "ç†Ÿç»ƒåº¦"];
                }}
              />
              <Bar
                dataKey="value"
                fill="#3b82f6"
                radius={[0, 4, 4, 0]}
                background={{
                  fill: document.documentElement.classList.contains("dark")
                    ? "#374151"
                    : "#f3f4f6",
                }}
              />
            </BarChart>
          )}
        </ResponsiveContainer>
      </div>

      {/* å›¾ä¾‹è¯´æ˜ */}
      <div className="mt-4 text-xs text-gray-500 dark:text-gray-400 flex items-center gap-4">
        <div className="flex items-center gap-1">
          <div className="w-3 h-3 bg-blue-500 rounded"></div>
          <span>å½“å‰æŠ€èƒ½æ°´å¹³</span>
        </div>
        <div>â€¢ æ»¡åˆ†100%</div>
      </div>
    </div>
  );
};

export default SkillsHeatmap;


===== src/components/Typewriter.tsx =====
import { useState, useEffect } from "react";

interface TypewriterProps {
  texts: string[]; // è¦è½®æ¢çš„æ–‡å­—æ•°ç»„
  delay?: number; // æ‰“å­—é€Ÿåº¦
  pause?: number; // æš‚åœæ—¶é—´
}

const Typewriter: React.FC<TypewriterProps> = ({
  texts,
  delay = 100,
  pause = 2000,
}) => {
  const [currentTextIndex, setCurrentTextIndex] = useState(0);
  const [currentText, setCurrentText] = useState("");
  const [isDeleting, setIsDeleting] = useState(false);

  useEffect(() => {
    const timer = setTimeout(
      () => {
        const fullText = texts[currentTextIndex];

        if (!isDeleting) {
          // æ‰“å­—
          if (currentText.length < fullText.length) {
            setCurrentText(fullText.slice(0, currentText.length + 1));
          } else {
            // æ‰“å®Œäº†ï¼Œç­‰å¾…åå¼€å§‹åˆ é™¤
            setTimeout(() => setIsDeleting(true), pause);
          }
        } else {
          // åˆ é™¤
          if (currentText.length > 0) {
            setCurrentText(currentText.slice(0, -1));
          } else {
            // åˆ å®Œäº†ï¼Œåˆ‡æ¢åˆ°ä¸‹ä¸€ä¸ªè¯
            setIsDeleting(false);
            setCurrentTextIndex((prev) => (prev + 1) % texts.length);
          }
        }
      },
      isDeleting ? delay / 2 : delay,
    );

    return () => clearTimeout(timer);
  }, [currentText, currentTextIndex, isDeleting, texts, delay, pause]);

  return (
    <span className="inline-block min-w-[200px] text-blue-600 dark:text-blue-400">
      {currentText}
      <span className="animate-pulse">|</span>
    </span>
  );
};

export default Typewriter;


===== src/components/VisitorCounter.tsx =====
// src/components/VisitorCounter.tsx
import { useState, useEffect } from "react";
import { supabase } from "../lib/supabase";

const VisitorCounter = () => {
  const [count, setCount] = useState<number | null>(null);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    const handleVisitor = async () => {
      try {
        // æ£€æŸ¥æ˜¯å¦å·²ç»åœ¨æœ¬ä¼šè¯ä¸­è®¿é—®è¿‡
        const hasVisited = sessionStorage.getItem("hasVisited");

        if (!hasVisited) {
          // æ–°è®¿å®¢ï¼šå…ˆè·å–å½“å‰è®¡æ•°
          const { data: currentData, error: selectError } = await supabase
            .from("site_stats")
            .select("visitor_count")
            .eq("id", 1)
            .single();

          if (selectError) throw selectError;

          // æ›´æ–°è®¡æ•° +1
          const newCount = (currentData?.visitor_count || 0) + 1;
          const { error: updateError } = await supabase
            .from("site_stats")
            .update({
              visitor_count: newCount,
              updated_at: new Date().toISOString(),
            })
            .eq("id", 1);

          if (updateError) throw updateError;

          setCount(newCount);
          sessionStorage.setItem("hasVisited", "true");
        } else {
          // è€è®¿å®¢ï¼šåªè·å–å½“å‰è®¡æ•°
          const { data, error } = await supabase
            .from("site_stats")
            .select("visitor_count")
            .eq("id", 1)
            .single();

          if (error) throw error;
          setCount(data.visitor_count);
        }
      } catch (error) {
        console.error("Error updating visitor count:", error);
        // å‡ºé”™æ—¶æ˜¾ç¤ºé»˜è®¤å€¼
        setCount(0);
      } finally {
        setLoading(false);
      }
    };

    handleVisitor();
  }, []);

  if (loading) {
    return (
      <div className="text-sm text-gray-400 dark:text-gray-500 animate-pulse">
        Â·Â·Â·
      </div>
    );
  }

  return (
    <div className="flex items-center gap-1.5 text-sm text-gray-600 dark:text-gray-400">
      <svg
        className="w-4 h-4"
        fill="none"
        stroke="currentColor"
        viewBox="0 0 24 24"
      >
        <path
          strokeLinecap="round"
          strokeLinejoin="round"
          strokeWidth={2}
          d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"
        />
      </svg>
      <span>{count}</span>
    </div>
  );
};

export default VisitorCounter;


===== src/components/admin/AdminLayout.tsx =====
import React from "react";
import { Link, Outlet, useNavigate } from "react-router-dom";
import { useAuthStore } from "../../store/authStore";

const AdminLayout: React.FC = () => {
  const { user, signOut } = useAuthStore();
  const navigate = useNavigate();

  const isAdmin = user?.email === "mydykitty@126.com";

  if (!user) {
    navigate("/");
    return null;
  }

  if (!isAdmin) {
    return (
      <div className="max-w-4xl mx-auto px-4 py-16 text-center">
        <h1 className="text-2xl font-bold mb-4">æ— æƒè®¿é—®</h1>
        <p className="text-gray-600 dark:text-gray-400">
          åªæœ‰ç®¡ç†å‘˜å¯ä»¥è®¿é—®åå°
        </p>
        <Link
          to="/"
          className="text-blue-500 hover:text-blue-600 mt-4 inline-block"
        >
          è¿”å›é¦–é¡µ
        </Link>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-gray-100 dark:bg-gray-900">
      <nav className="bg-white dark:bg-gray-800 shadow-sm">
        <div className="max-w-7xl mx-auto px-4">
          <div className="flex justify-between h-16">
            <div className="flex">
              <Link
                to="/admin"
                className="flex items-center px-4 text-gray-900 dark:text-white font-bold"
              >
                ç®¡ç†åå°
              </Link>
              <div className="flex space-x-4 ml-6">
                <Link
                  to="/admin/dashboard"
                  className="inline-flex items-center px-3 text-gray-700 dark:text-gray-300 hover:text-blue-500"
                >
                  ä»ªè¡¨ç›˜
                </Link>
                <Link
                  to="/admin/posts"
                  className="inline-flex items-center px-3 text-gray-700 dark:text-gray-300 hover:text-blue-500"
                >
                  æ–‡ç« ç®¡ç†
                </Link>
                <Link
                  to="/admin/categories"
                  className="inline-flex items-center px-3 text-gray-700 dark:text-gray-300 hover:text-blue-500"
                >
                  åˆ†ç±»ç®¡ç†
                </Link>
                {/* ğŸ”´ æ–°å¢ï¼šæ¥æºåˆ†æ */}
                <Link
                  to="/admin/sources"
                  className="inline-flex items-center px-3 text-gray-700 dark:text-gray-300 hover:text-blue-500"
                >
                  æ¥æºåˆ†æ
                </Link>
                <Link
                  to="/profile"
                  className="inline-flex items-center px-3 text-gray-700 dark:text-gray-300 hover:text-blue-500"
                >
                  ä¸ªäººèµ„æ–™
                </Link>
              </div>
            </div>
            <div className="flex items-center space-x-4">
              <Link
                to="/"
                className="text-gray-700 dark:text-gray-300 hover:text-blue-500"
              >
                è¿”å›ç½‘ç«™
              </Link>
              <button
                onClick={signOut}
                className="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600"
              >
                é€€å‡º
              </button>
            </div>
          </div>
        </div>
      </nav>

      <main className="py-8">
        <Outlet />
      </main>
    </div>
  );
};

export default AdminLayout;


===== src/components/admin/PostEditor.tsx =====
import React, { useEffect, useState } from "react";
import { useParams, useNavigate } from "react-router-dom";
import { supabase } from "../../lib/supabase";
import { useAuthStore } from "../../store/authStore";
import type { Category } from "../../types/blog";

const PostEditor: React.FC = () => {
  const { id } = useParams(); // å¦‚æœæœ‰idè¡¨ç¤ºç¼–è¾‘ï¼Œæ²¡æœ‰å°±æ˜¯æ–°å»º
  const navigate = useNavigate();
  const user = useAuthStore((state) => state.user);

  const [title, setTitle] = useState("");
  const [content, setContent] = useState("");
  const [excerpt, setExcerpt] = useState("");
  const [categoryId, setCategoryId] = useState<number | null>(null);
  const [tags, setTags] = useState("");
  const [isPublished, setIsPublished] = useState(false);
  const [categories, setCategories] = useState<Category[]>([]);
  const [loading, setLoading] = useState(false);
  const [saving, setSaving] = useState(false);

  // åŠ è½½åˆ†ç±»åˆ—è¡¨
  useEffect(() => {
    fetchCategories();
    if (id) {
      fetchPost();
    }
  }, [id]);

  const fetchCategories = async () => {
    const { data } = await supabase
      .from("categories")
      .select("*")
      .order("name");
    setCategories(data || []);
  };

  // å¦‚æœæ˜¯ç¼–è¾‘æ¨¡å¼ï¼ŒåŠ è½½æ–‡ç« æ•°æ®
  const fetchPost = async () => {
    setLoading(true);
    const { data } = await supabase
      .from("posts")
      .select("*")
      .eq("id", id)
      .single();

    if (data) {
      setTitle(data.title);
      setContent(data.content);
      setExcerpt(data.excerpt || "");
      setCategoryId(data.category_id);
      setTags(data.tags?.join(", ") || "");
      setIsPublished(data.is_published);
    }
    setLoading(false);
  };

  // ç”ŸæˆURLå‹å¥½çš„slug
  const generateSlug = (title: string): string => {
    return title
      .toLowerCase()
      .replace(/[^a-zA-Z0-9\u4e00-\u9fa5]/g, "-")
      .replace(/-+/g, "-")
      .replace(/^-|-$/g, "");
  };

  // ä¿å­˜æ–‡ç« 
  const savePost = async () => {
    if (!title || !content) {
      alert("æ ‡é¢˜å’Œå†…å®¹ä¸èƒ½ä¸ºç©º");
      return;
    }

    setSaving(true);
    const slug = generateSlug(title);
    const tagArray = tags
      .split(",")
      .map((t) => t.trim())
      .filter((t) => t);

    // å‡†å¤‡æ–‡ç« æ•°æ®
    const postData = {
      title,
      slug,
      content,
      excerpt: excerpt || content.substring(0, 150) + "...",
      category_id: categoryId,
      tags: tagArray,
      is_published: isPublished,
      published_at: isPublished ? new Date().toISOString() : null,
      user_id: user?.id,
      updated_at: new Date().toISOString(),
    };

    try {
      let oldCategoryId = null;

      // å¦‚æœæ˜¯ç¼–è¾‘æ¨¡å¼ï¼Œå…ˆè·å–åŸæ¥çš„åˆ†ç±»ID
      if (id) {
        const { data: oldPost } = await supabase
          .from("posts")
          .select("category_id")
          .eq("id", id)
          .single();

        oldCategoryId = oldPost?.category_id;
      }

      // ä¿å­˜æ–‡ç« 
      let error;
      if (id) {
        // ç¼–è¾‘æ–‡ç« 
        ({ error } = await supabase
          .from("posts")
          .update(postData)
          .eq("id", id));
      } else {
        // æ–°å»ºæ–‡ç« 
        ({ error } = await supabase.from("posts").insert([postData]));
      }

      if (error) throw error;

      // ğŸ”´ æ›´æ–°åˆ†ç±»çš„æ–‡ç« æ•°é‡ï¼ˆå†™æ³•ä¸‰ï¼‰
      if (id) {
        // ç¼–è¾‘æ¨¡å¼ï¼šå¤„ç†åˆ†ç±»å˜åŒ–
        if (oldCategoryId !== categoryId) {
          // æ—§åˆ†ç±»å‡1
          if (oldCategoryId) {
            // å…ˆæŸ¥è¯¢å½“å‰å€¼
            const { data: oldCategory } = await supabase
              .from("categories")
              .select("post_count")
              .eq("id", oldCategoryId)
              .single();

            if (oldCategory) {
              await supabase
                .from("categories")
                .update({ post_count: Math.max(0, oldCategory.post_count - 1) })
                .eq("id", oldCategoryId);
            }
          }

          // æ–°åˆ†ç±»åŠ 1
          if (categoryId) {
            // å…ˆæŸ¥è¯¢å½“å‰å€¼
            const { data: newCategory } = await supabase
              .from("categories")
              .select("post_count")
              .eq("id", categoryId)
              .single();

            if (newCategory) {
              await supabase
                .from("categories")
                .update({ post_count: newCategory.post_count + 1 })
                .eq("id", categoryId);
            }
          }
        }
      } else {
        // æ–°å»ºæ¨¡å¼ï¼šæœ‰åˆ†ç±»çš„è¯ç›´æ¥åŠ 1
        if (categoryId) {
          // å…ˆæŸ¥è¯¢å½“å‰å€¼
          const { data: category } = await supabase
            .from("categories")
            .select("post_count")
            .eq("id", categoryId)
            .single();

          if (category) {
            await supabase
              .from("categories")
              .update({ post_count: category.post_count + 1 })
              .eq("id", categoryId);
          }
        }
      }

      navigate("/admin/posts");
    } catch (err: any) {
      alert("ä¿å­˜å¤±è´¥ï¼š" + err.message);
    } finally {
      setSaving(false);
    }
  };

  if (loading) {
    return (
      <div className="flex justify-center items-center h-64">
        <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500"></div>
      </div>
    );
  }

  return (
    <div className="max-w-4xl mx-auto px-4">
      {/* å¤´éƒ¨ */}
      <div className="flex justify-between items-center mb-8">
        <h1 className="text-3xl font-bold">{id ? "ç¼–è¾‘æ–‡ç« " : "å†™æ–°æ–‡ç« "}</h1>
        <button
          onClick={() => navigate("/admin/posts")}
          className="px-4 py-2 text-gray-600 dark:text-gray-400 hover:text-gray-900"
        >
          å–æ¶ˆ
        </button>
      </div>

      <div className="space-y-6">
        {/* æ ‡é¢˜ */}
        <div>
          <label className="block text-sm font-medium mb-2">
            æ ‡é¢˜ <span className="text-red-500">*</span>
          </label>
          <input
            type="text"
            value={title}
            onChange={(e) => setTitle(e.target.value)}
            className="w-full px-4 py-2 border rounded-lg dark:bg-gray-800 dark:border-gray-700 focus:ring-2 focus:ring-blue-500"
            placeholder="è¯·è¾“å…¥æ–‡ç« æ ‡é¢˜"
          />
        </div>

        {/* åˆ†ç±»å’Œæ ‡ç­¾ */}
        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label className="block text-sm font-medium mb-2">åˆ†ç±»</label>
            <select
              value={categoryId || ""}
              onChange={(e) => setCategoryId(Number(e.target.value) || null)}
              className="w-full px-4 py-2 border rounded-lg dark:bg-gray-800 dark:border-gray-700"
            >
              <option value="">æ— åˆ†ç±»</option>
              {categories.map((cat) => (
                <option key={cat.id} value={cat.id}>
                  {cat.name}
                </option>
              ))}
            </select>
          </div>
          <div>
            <label className="block text-sm font-medium mb-2">æ ‡ç­¾</label>
            <input
              type="text"
              value={tags}
              onChange={(e) => setTags(e.target.value)}
              className="w-full px-4 py-2 border rounded-lg dark:bg-gray-800 dark:border-gray-700"
              placeholder="ç”¨é€—å·åˆ†éš”ï¼Œå¦‚ï¼šReact, TypeScript"
            />
          </div>
        </div>

        {/* æ‘˜è¦ */}
        <div>
          <label className="block text-sm font-medium mb-2">æ‘˜è¦</label>
          <textarea
            value={excerpt}
            onChange={(e) => setExcerpt(e.target.value)}
            rows={3}
            className="w-full px-4 py-2 border rounded-lg dark:bg-gray-800 dark:border-gray-700"
            placeholder="æ–‡ç« æ‘˜è¦ï¼ˆé€‰å¡«ï¼Œä¸å¡«åˆ™è‡ªåŠ¨æˆªå–å†…å®¹å‰150å­—ï¼‰"
          />
        </div>

        {/* å†…å®¹ */}
        <div>
          <label className="block text-sm font-medium mb-2">
            å†…å®¹ <span className="text-red-500">*</span>
          </label>
          <textarea
            value={content}
            onChange={(e) => setContent(e.target.value)}
            rows={20}
            className="w-full px-4 py-2 border rounded-lg dark:bg-gray-800 dark:border-gray-700 font-mono"
            placeholder="æ”¯æŒ Markdown æ ¼å¼"
          />
          <p className="text-xs text-gray-500 mt-1">
            æ”¯æŒ Markdown è¯­æ³•ï¼š # æ ‡é¢˜ï¼Œ **åŠ ç²—**ï¼Œ - åˆ—è¡¨ï¼Œ [é“¾æ¥](url) ç­‰
          </p>
        </div>

        {/* å‘å¸ƒé€‰é¡¹ */}
        <div className="flex items-center gap-6 p-4 bg-gray-50 dark:bg-gray-800 rounded-lg">
          <label className="flex items-center gap-2">
            <input
              type="checkbox"
              checked={isPublished}
              onChange={(e) => setIsPublished(e.target.checked)}
              className="w-4 h-4 rounded border-gray-300"
            />
            <span className="text-sm font-medium">ç«‹å³å‘å¸ƒ</span>
          </label>
          {!isPublished && (
            <span className="text-sm text-yellow-600 dark:text-yellow-500">
              âš ï¸ è‰ç¨¿çŠ¶æ€ï¼Œä¸ä¼šåœ¨åšå®¢åˆ—è¡¨æ˜¾ç¤º
            </span>
          )}
        </div>

        {/* æŒ‰é’®ç»„ */}
        <div className="flex gap-4 pt-4">
          <button
            onClick={savePost}
            disabled={saving}
            className="px-6 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 disabled:opacity-50 disabled:cursor-not-allowed"
          >
            {saving ? "ä¿å­˜ä¸­..." : id ? "æ›´æ–°æ–‡ç« " : "å‘å¸ƒæ–‡ç« "}
          </button>
          <button
            onClick={() => navigate("/admin/posts")}
            className="px-6 py-2 bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600"
          >
            è¿”å›åˆ—è¡¨
          </button>
        </div>
      </div>
    </div>
  );
};

export default PostEditor;


===== src/components/blog/BlogCard.tsx =====
import React from "react";
import { Link } from "react-router-dom";
import type { Post } from "../../types/blog";
import LazyImage from "../common/LazyImage";

interface BlogCardProps {
  post: Post;
  searchQuery?: string; // æ–°å¢ï¼šæœç´¢å…³é”®è¯ï¼Œç”¨äºé«˜äº®
}

const BlogCard: React.FC<BlogCardProps> = ({ post, searchQuery = "" }) => {
  // é«˜äº®æœç´¢å…³é”®è¯çš„å‡½æ•°
  const highlightText = (text: string, query: string) => {
    if (!query || !text) return text;

    try {
      const parts = text.split(new RegExp(`(${query})`, "gi"));
      return parts.map((part, i) =>
        part.toLowerCase() === query.toLowerCase() ? (
          <mark
            key={i}
            className="bg-yellow-200 dark:bg-yellow-800 px-0.5 rounded"
          >
            {part}
          </mark>
        ) : (
          part
        ),
      );
    } catch (e) {
      // å¦‚æœæ­£åˆ™è¡¨è¾¾å¼å‡ºé”™ï¼ˆæ¯”å¦‚ç‰¹æ®Šå­—ç¬¦ï¼‰ï¼Œè¿”å›åŸæ–‡æœ¬
      return text;
    }
  };

  // è·å–æ˜¾ç¤ºçš„æ‘˜è¦ï¼ˆå¦‚æœæœ‰excerptå°±ç”¨ï¼Œå¦åˆ™æˆªå–å†…å®¹ï¼‰
  const getExcerpt = () => {
    if (post.excerpt) return post.excerpt;
    return post.content.substring(0, 150) + "...";
  };

  return (
    <article className="bg-white dark:bg-gray-800 rounded-lg shadow-md overflow-hidden hover:shadow-lg transition-shadow">
      {post.cover_image && (
        <LazyImage
          src={post.cover_image}
          alt={post.title}
          className="w-full h-48 object-cover"
          width={400}
          height={192}
        />
      )}
      <div className="p-6">
        {/* æ ‡ç­¾åŒºåŸŸ */}
        {post.tags && post.tags.length > 0 && (
          <div className="flex flex-wrap gap-2 mb-2">
            {post.tags.map((tag) => (
              <span
                key={tag}
                className="text-xs bg-blue-100 dark:bg-blue-900 text-blue-600 dark:text-blue-300 px-2 py-1 rounded"
              >
                #{tag}
              </span>
            ))}
          </div>
        )}

        {/* æ ‡é¢˜ï¼ˆå¯é«˜äº®ï¼‰ */}
        <Link to={`/blog/${post.slug}`}>
          <h3 className="text-xl font-bold text-gray-900 dark:text-white hover:text-blue-600 dark:hover:text-blue-400 mb-2">
            {searchQuery ? highlightText(post.title, searchQuery) : post.title}
          </h3>
        </Link>

        {/* æ‘˜è¦ï¼ˆå¯é«˜äº®ï¼‰ */}
        <p className="text-gray-600 dark:text-gray-400 mb-4">
          {searchQuery
            ? highlightText(getExcerpt(), searchQuery)
            : getExcerpt()}
        </p>

        {/* å…ƒä¿¡æ¯ */}
        <div className="flex justify-between items-center text-sm text-gray-500 dark:text-gray-400">
          <span>{new Date(post.published_at).toLocaleDateString("zh-CN")}</span>
          <div className="flex gap-4">
            <span title="é˜…è¯»é‡">ğŸ‘ï¸ {post.view_count}</span>
            <span title="ç‚¹èµæ•°">â¤ï¸ {post.like_count}</span>
            <span title="è¯„è®ºæ•°">ğŸ’¬ {post.comment_count}</span>
          </div>
        </div>
      </div>
    </article>
  );
};

export default BlogCard;


===== src/components/blog/BlogComments.tsx =====
import React, { useEffect, useState } from "react";
import { supabase } from "../../lib/supabase";
import { useAuthStore } from "../../store/authStore";

interface Comment {
  id: number;
  content: string;
  created_at: string;
  user_id: string;
  user?: {
    name: string;
    avatar: string;
  };
  likes_count: number;
}

interface BlogCommentsProps {
  postId: number;
}

const BlogComments: React.FC<BlogCommentsProps> = ({ postId }) => {
  const [comments, setComments] = useState<Comment[]>([]);
  const [newComment, setNewComment] = useState("");
  const [loading, setLoading] = useState(false);
  const user = useAuthStore((state) => state.user);

  useEffect(() => {
    fetchComments();
  }, [postId]);

  const fetchComments = async () => {
    const { data } = await supabase
      .from("post_comments")
      .select("*")
      .eq("post_id", postId)
      .order("created_at", { ascending: false });

    setComments(data || []);
  };

  const submitComment = async (e: React.FormEvent) => {
    e.preventDefault();
    if (!user || !newComment.trim()) return;

    setLoading(true);
    const { error } = await supabase.from("post_comments").insert({
      post_id: postId,
      user_id: user.id,
      content: newComment.trim(),
    });

    if (!error) {
      setNewComment("");
      fetchComments();
      // æ›´æ–°æ–‡ç« è¯„è®ºæ•°
      await supabase
        .from("posts")
        .update({ comment_count: comments.length + 1 })
        .eq("id", postId);
    }
    setLoading(false);
  };

  return (
    <div className="mt-12">
      <h3 className="text-2xl font-bold mb-6">è¯„è®º ({comments.length})</h3>

      {/* è¯„è®ºè¡¨å• */}
      {user ? (
        <form onSubmit={submitComment} className="mb-8">
          <textarea
            value={newComment}
            onChange={(e) => setNewComment(e.target.value)}
            placeholder="å†™ä¸‹ä½ çš„è¯„è®º..."
            rows={3}
            className="w-full px-4 py-2 border rounded-lg dark:bg-gray-800"
          />
          <button
            type="submit"
            disabled={loading}
            className="mt-2 px-6 py-2 bg-blue-500 text-white rounded-lg"
          >
            {loading ? "å‘å¸ƒä¸­..." : "å‘å¸ƒè¯„è®º"}
          </button>
        </form>
      ) : (
        <p className="mb-8 text-gray-500">è¯·å…ˆç™»å½•åå†è¯„è®º</p>
      )}

      {/* è¯„è®ºåˆ—è¡¨ */}
      <div className="space-y-4">
        {comments.map((comment) => (
          <div
            key={comment.id}
            className="p-4 bg-gray-50 dark:bg-gray-800 rounded-lg"
          >
            <p>{comment.content}</p>
            <div className="mt-2 text-sm text-gray-500">
              {new Date(comment.created_at).toLocaleString()}
            </div>
          </div>
        ))}
      </div>
    </div>
  );
};

export default BlogComments;


===== src/components/blog/BlogTOC.tsx =====
import React, { useEffect, useState } from "react";

interface TOCItem {
  id: string;
  text: string;
  level: number;
}

const BlogTOC: React.FC<{ content: string }> = ({ content }) => {
  const [headings, setHeadings] = useState<TOCItem[]>([]);

  useEffect(() => {
    const lines = content.split("\n");
    const extracted: TOCItem[] = [];

    lines.forEach((line) => {
      const match = line.match(/^(#{1,3})\s+(.+)/);
      if (match) {
        const level = match[1].length;
        const text = match[2];
        const id = text.toLowerCase().replace(/\s+/g, "-");
        extracted.push({ id, text, level });
      }
    });

    setHeadings(extracted);
  }, [content]);

  if (headings.length === 0) return null;

  return (
    <div className="bg-gray-50 dark:bg-gray-800 rounded-lg p-4 sticky top-4">
      <h4 className="font-bold mb-3">ğŸ“– ç›®å½•</h4>
      <nav>
        {headings.map((heading, index) => (
          <a
            key={index}
            href={`#${heading.id}`}
            className="block text-sm hover:text-blue-500 transition-colors mb-1"
            style={{ paddingLeft: `${(heading.level - 1) * 12}px` }}
          >
            {heading.text}
          </a>
        ))}
      </nav>
    </div>
  );
};

export default BlogTOC;


===== src/components/blog/CodeBlock.tsx =====
import React from "react";
import { Prism as SyntaxHighlighter } from "react-syntax-highlighter";
import {
  vscDarkPlus,
  vs,
} from "react-syntax-highlighter/dist/esm/styles/prism";

interface CodeBlockProps {
  className?: string;
  children?: React.ReactNode;
}

const CodeBlock: React.FC<CodeBlockProps> = ({ className, children }) => {
  const match = /language-(\w+)/.exec(className || "");
  const isDark = document.documentElement.classList.contains("dark");

  // åˆ¤æ–­æ˜¯å¦æ˜¯è¡Œå†…ä»£ç 
  const isInline = !match && String(children).includes("\n") === false;

  // å¦‚æœæ˜¯è¡Œå†…ä»£ç ï¼Œç›´æ¥è¿”å›codeæ ‡ç­¾
  if (isInline) {
    return <code className={className}>{children}</code>;
  }

  // å¦‚æœæ˜¯ä»£ç å—ä¸”æœ‰è¯­è¨€æ ‡è®°ï¼Œä½¿ç”¨è¯­æ³•é«˜äº®
  if (match) {
    return (
      <div className="relative group">
        <SyntaxHighlighter
          language={match[1]}
          style={isDark ? vscDarkPlus : vs}
          showLineNumbers={true}
          wrapLines={true}
          customStyle={{
            margin: 0,
            borderRadius: "0.5rem",
            fontSize: "0.9rem",
            padding: "1rem",
          }}
        >
          {String(children).replace(/\n$/, "")}
        </SyntaxHighlighter>

        {/* å¤åˆ¶æŒ‰é’® */}
        <button
          onClick={() => {
            navigator.clipboard.writeText(String(children).replace(/\n$/, ""));
            alert("ä»£ç å·²å¤åˆ¶åˆ°å‰ªè´´æ¿");
          }}
          className="absolute top-2 right-2 px-2 py-1 text-xs bg-gray-700 text-white rounded opacity-0 group-hover:opacity-100 transition-opacity"
        >
          å¤åˆ¶
        </button>
      </div>
    );
  }

  // å¦‚æœæ˜¯ä»£ç å—ä½†æ²¡æœ‰è¯­è¨€æ ‡è®°ï¼Œä½¿ç”¨æ™®é€špre
  return (
    <pre className="bg-gray-100 dark:bg-gray-800 p-4 rounded-lg overflow-x-auto">
      <code>{children}</code>
    </pre>
  );
};

export default CodeBlock;


===== src/components/blog/ReadingProgress.tsx =====
import React, { useEffect, useState } from "react";

const ReadingProgress: React.FC = () => {
  const [progress, setProgress] = useState(0);

  useEffect(() => {
    const updateProgress = () => {
      const scrollTop = window.scrollY;
      const windowHeight = window.innerHeight;
      const documentHeight = document.documentElement.scrollHeight;

      // è®¡ç®—æ»šåŠ¨ç™¾åˆ†æ¯”
      const totalScroll = documentHeight - windowHeight;
      const currentProgress =
        totalScroll > 0 ? (scrollTop / totalScroll) * 100 : 0;

      setProgress(currentProgress);
    };

    window.addEventListener("scroll", updateProgress);
    return () => window.removeEventListener("scroll", updateProgress);
  }, []);

  return (
    <div className="fixed top-0 left-0 w-full h-1 bg-gray-200 dark:bg-gray-700 z-50">
      <div
        className="h-full bg-blue-500 transition-all duration-100"
        style={{ width: `${progress}%` }}
      />
    </div>
  );
};

export default ReadingProgress;


===== src/components/common/Button.tsx =====
import type { FC, ButtonHTMLAttributes } from "react";

const Button: FC<ButtonHTMLAttributes<HTMLButtonElement>> = (props) => (
  <button
    {...props}
    className="rounded border border-transparent px-4 py-2 font-medium cursor-pointer transition-colors duration-300 bg-gray-200 dark:bg-gray-800 hover:bg-gray-300 dark:hover:bg-gray-700 text-gray-900 dark:text-gray-100"
  />
);

export default Button;


===== src/components/common/LazyImage.tsx =====
import React, { useState, useEffect, useRef } from "react";

interface LazyImageProps {
  src: string;
  alt: string;
  className?: string;
  placeholder?: string;
  webp?: boolean;
  width?: number;
  height?: number;
  mobile?: string; // ç§»åŠ¨ç«¯å›¾ç‰‡
  tablet?: string; // å¹³æ¿ç«¯å›¾ç‰‡
  desktop?: string; // æ¡Œé¢ç«¯å›¾ç‰‡
}

const LazyImage: React.FC<LazyImageProps> = ({
  src,
  alt,
  className = "",
  placeholder = 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"%3E%3Crect width="100" height="100" fill="%23f0f0f0"/%3E%3C/svg%3E',
  webp = true,
  width,
  height,
  mobile,
  tablet,
  desktop,
}) => {
  const [imageSrc, setImageSrc] = useState(placeholder);
  const [isLoaded, setIsLoaded] = useState(false);
  const [error, setError] = useState(false);
  const imgRef = useRef<HTMLImageElement>(null);

  // æ ¹æ®å±å¹•å®½åº¦é€‰æ‹©å›¾ç‰‡
  const getResponsiveImage = () => {
    if (typeof window === "undefined") return src;

    const width = window.innerWidth;
    if (mobile && width < 640) return mobile;
    if (tablet && width >= 640 && width < 1024) return tablet;
    if (desktop && width >= 1024) return desktop;
    return src;
  };

  useEffect(() => {
    const observer = new IntersectionObserver(
      (entries) => {
        entries.forEach((entry) => {
          if (entry.isIntersecting) {
            loadImage();
            observer.disconnect();
          }
        });
      },
      { rootMargin: "50px", threshold: 0.01 },
    );

    if (imgRef.current) {
      observer.observe(imgRef.current);
    }

    return () => observer.disconnect();
  }, []);

  const loadImage = () => {
    const img = new Image();

    // è·å–å“åº”å¼å›¾ç‰‡
    const responsiveSrc = getResponsiveImage();

    // æ£€æŸ¥æ˜¯å¦æ”¯æŒWebP
    const useWebP = webp && checkWebPSupport();

    let imageUrl = responsiveSrc;
    if (useWebP && responsiveSrc.match(/\.(jpg|jpeg|png)$/)) {
      imageUrl = responsiveSrc.replace(/\.(jpg|jpeg|png)$/, ".webp");
    }

    img.src = imageUrl;
    img.onload = () => {
      setImageSrc(imageUrl);
      setIsLoaded(true);
    };
    img.onerror = () => {
      if (useWebP) {
        loadOriginalImage(responsiveSrc);
      } else {
        setError(true);
        setImageSrc(placeholder);
      }
    };
  };

  const loadOriginalImage = (originalSrc: string) => {
    const img = new Image();
    img.src = originalSrc;
    img.onload = () => {
      setImageSrc(originalSrc);
      setIsLoaded(true);
    };
    img.onerror = () => {
      setError(true);
      setImageSrc(placeholder);
    };
  };

  const checkWebPSupport = () => {
    const canvas = document.createElement("canvas");
    canvas.width = 1;
    canvas.height = 1;
    return canvas.toDataURL("image/webp").indexOf("image/webp") === 5;
  };

  return (
    <div className="relative overflow-hidden" style={{ width, height }}>
      {!isLoaded && (
        <div className="absolute inset-0 bg-gray-200 dark:bg-gray-700 animate-pulse" />
      )}

      <img
        ref={imgRef}
        src={imageSrc}
        alt={alt}
        className={`
          ${className}
          transition-opacity duration-300
          ${isLoaded ? "opacity-100" : "opacity-0"}
          ${error ? "opacity-50" : ""}
        `}
        style={{ width, height }}
        loading="lazy"
      />

      {error && (
        <div className="absolute inset-0 flex items-center justify-center bg-gray-100 dark:bg-gray-800 text-gray-500 text-sm">
          å›¾ç‰‡åŠ è½½å¤±è´¥
        </div>
      )}
    </div>
  );
};

export default LazyImage;


===== src/components/common/LoadingSpinner.tsx =====
import React from "react";

interface LoadingSpinnerProps {
  /** æ˜¯å¦å…¨å±æ˜¾ç¤º */
  fullScreen?: boolean;
  /** å°ºå¯¸ï¼šsm|md|lg */
  size?: "sm" | "md" | "lg";
  /** åŠ è½½æ–‡å­— */
  text?: string;
}

const LoadingSpinner: React.FC<LoadingSpinnerProps> = ({
  fullScreen = false,
  size = "md",
  text,
}) => {
  // å°ºå¯¸æ˜ å°„
  const sizeMap = {
    sm: "h-6 w-6 border-2",
    md: "h-12 w-12 border-4",
    lg: "h-16 w-16 border-4",
  };

  // å…¨å±æ ·å¼
  const containerClass = fullScreen
    ? "fixed inset-0 flex flex-col items-center justify-center bg-white/80 dark:bg-gray-900/80 z-50"
    : "flex flex-col items-center justify-center py-12";

  return (
    <div className={containerClass}>
      {/* æ—‹è½¬åœ†åœˆ */}
      <div
        className={`${sizeMap[size]} rounded-full border-blue-200 border-t-blue-500 animate-spin`}
      />

      {/* åŠ è½½æ–‡å­— */}
      {text && <p className="mt-4 text-gray-600 dark:text-gray-400">{text}</p>}
    </div>
  );
};

export default LoadingSpinner;


===== src/components/common/ResponsiveImage.tsx =====
import React from "react";

interface ResponsiveImageProps {
  src: string;
  alt: string;
  className?: string;
  sizes?: string;
  mobile?: string; // ç§»åŠ¨ç«¯å›¾ç‰‡
  tablet?: string; // å¹³æ¿ç«¯å›¾ç‰‡
  desktop?: string; // æ¡Œé¢ç«¯å›¾ç‰‡
}

const ResponsiveImage: React.FC<ResponsiveImageProps> = ({
  src,
  alt,
  className = "",
  sizes = "100vw",
  mobile,
  tablet,
  desktop,
}) => {
  // ç”Ÿæˆsrcset
  const generateSrcSet = () => {
    const sources = [];

    if (mobile) {
      sources.push(`${mobile} 480w`);
    }
    if (tablet) {
      sources.push(`${tablet} 768w`);
    }
    if (desktop) {
      sources.push(`${desktop} 1024w`);
    }

    // é»˜è®¤å›¾ç‰‡
    sources.push(`${src} 1920w`);

    return sources.join(", ");
  };

  return (
    <img
      src={src}
      srcSet={generateSrcSet()}
      sizes={sizes}
      alt={alt}
      className={className}
      loading="lazy"
    />
  );
};

export default ResponsiveImage;


===== src/data/skills.ts =====
export interface Skill {
  name: string;
  level: number; // 0~100
}

export const skills: Skill[] = [
  { name: "HTML", level: 90 },
  { name: "CSS", level: 85 },
  { name: "JavaScript", level: 80 },
  { name: "TypeScript", level: 75 },
  { name: "React", level: 85 },
  { name: "TailwindCSS", level: 70 },
];


===== src/i18n/config.ts =====
import i18n from 'i18next';
import { initReactI18next } from 'react-i18next';
import LanguageDetector from 'i18next-browser-languagedetector';

import zh from './locales/zh.json';
import en from './locales/en.json';

i18n
  .use(LanguageDetector)  // è‡ªåŠ¨æ£€æµ‹è¯­è¨€
  .use(initReactI18next)  // ç»‘å®š react
  .init({
    resources: {
      zh: { translation: zh },
      en: { translation: en }
    },
    fallbackLng: 'zh',     // é»˜è®¤ä¸­æ–‡
    interpolation: {
      escapeValue: false   // React å·²ç»å®‰å…¨
    },
    detection: {
      order: ['localStorage', 'navigator'],
      caches: ['localStorage']
    }
  });

export default i18n;

===== src/index.css =====
@import "tailwindcss";
@plugin "@tailwindcss/typography";  /* åªéœ€æ·»åŠ è¿™ä¸€è¡Œ */
@custom-variant dark (&:where(.dark, .dark *)); /* æ‰‹åŠ¨å¯ç”¨ dark variant */

/* åŸºç¡€æ ·å¼ï¼Œè®©Tailwindå¤„ç†ä¸»é¢˜åˆ‡æ¢ */
body {
  margin: 0;
  min-width: 320px;
  min-height: 100vh;
  font-family: system-ui, Avenir, Helvetica, Arial, sans-serif;
  line-height: 1.5;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

/* src/index.css æœ«å°¾æ·»åŠ  */
.scroll-section {
  opacity: 0;
  transform: translateY(30px);
  transition: opacity 0.6s ease-out, transform 0.6s ease-out;
}

.scroll-section.show {
  opacity: 1;
  transform: translateY(0);
}

===== src/lib/supabase.ts =====
import { createClient } from '@supabase/supabase-js';

// ä» Supabase é¡¹ç›®è®¾ç½®ä¸­å¤åˆ¶
const supabaseUrl = import.meta.env.VITE_SUPABASE_URL;
const supabaseAnonKey = import.meta.env.VITE_SUPABASE_ANON_KEY;

if (!supabaseUrl || !supabaseAnonKey) {
    throw new Error('ç¼ºå°‘ Supabase ç¯å¢ƒå˜é‡');
}

export const supabase = createClient(supabaseUrl, supabaseAnonKey);

===== src/main.tsx =====
import React from "react";
import ReactDOM from "react-dom/client";
import App from "./App";
import "./index.css";

// å¼•å…¥ workbox çª—å£å·¥å…·
import { registerSW } from "virtual:pwa-register";

const updateSW = registerSW({
  onNeedRefresh() {
    // å½“æ£€æµ‹åˆ°æ–°ç‰ˆæœ¬æ—¶è§¦å‘
    if (confirm("å‘ç°æ–°ç‰ˆæœ¬ï¼Œæ˜¯å¦åˆ·æ–°é¡µé¢ä»¥è·å–æœ€æ–°å†…å®¹ï¼Ÿ")) {
      updateSW(true);
    }
  },
  onOfflineReady() {
    // å½“åº”ç”¨å‡†å¤‡å¥½ç¦»çº¿ä½¿ç”¨æ—¶è§¦å‘
    console.log("åº”ç”¨å·²å‡†å¤‡å¥½ç¦»çº¿ä½¿ç”¨");
    // è¿™é‡Œå¯ä»¥æ˜¾ç¤ºä¸€ä¸ª Toast æç¤ºç”¨æˆ· "å·²æ”¯æŒç¦»çº¿è®¿é—®"
  },
});

ReactDOM.createRoot(document.getElementById("root")!).render(
  <React.StrictMode>
    <App />
  </React.StrictMode>,
);


===== src/pages/BlogPage.tsx =====
import React, { useEffect, useState } from "react";
import { Link } from "react-router-dom";
import { supabase } from "../lib/supabase";
import BlogCard from "../components/blog/BlogCard";
import type { Post, Category } from "../types/blog";

const BlogPage: React.FC = () => {
  const [posts, setPosts] = useState<Post[]>([]);
  const [loading, setLoading] = useState(true);
  const [categories, setCategories] = useState<Category[]>([]);
  const [selectedCategory, setSelectedCategory] = useState<number | null>(null);

  // ğŸ”´ æ–°å¢ï¼šæœç´¢ç›¸å…³çŠ¶æ€
  const [searchQuery, setSearchQuery] = useState("");
  const [searchTimeout, setSearchTimeout] = useState<ReturnType<
    typeof setTimeout
  > | null>(null);

  useEffect(() => {
    fetchPosts();
    fetchCategories();
  }, [selectedCategory, searchQuery]); // åˆ†ç±»æˆ–æœç´¢å˜åŒ–æ—¶é‡æ–°æŸ¥è¯¢

  const fetchPosts = async () => {
    setLoading(true);
    let query = supabase
      .from("posts")
      .select(
        `
        *,
        category:categories(*)
      `,
      )
      .eq("is_published", true)
      .order("published_at", { ascending: false });

    // ğŸ”´ æŒ‰åˆ†ç±»ç­›é€‰
    if (selectedCategory) {
      query = query.eq("category_id", selectedCategory);
    }

    // ğŸ”´ æŒ‰æœç´¢è¯ç­›é€‰
    if (searchQuery.trim()) {
      query = query.or(
        `title.ilike.%${searchQuery}%,content.ilike.%${searchQuery}%`,
      );
    }

    const { data } = await query;
    setPosts(data || []);
    setLoading(false);
  };

  const fetchCategories = async () => {
    const { data } = await supabase
      .from("categories")
      .select("*")
      .order("post_count", { ascending: false });
    setCategories(data || []);
  };

  // ğŸ”´ é˜²æŠ–æœç´¢
  const handleSearch = (value: string) => {
    setSearchQuery(value); // è¾“å…¥æ¡†å®æ—¶æ›´æ–°

    // æ¸…é™¤ä¹‹å‰çš„å®šæ—¶å™¨
    if (searchTimeout) {
      clearTimeout(searchTimeout);
    }

    // è®¾ç½®æ–°çš„å®šæ—¶å™¨ï¼ˆ500msåæœç´¢ï¼‰
    const timeout = setTimeout(() => {
      fetchPosts(); // çœŸæ­£æ‰§è¡Œæœç´¢
    }, 500);

    setSearchTimeout(timeout);
  };

  // ç»„ä»¶å¸è½½æ—¶æ¸…é™¤å®šæ—¶å™¨
  useEffect(() => {
    return () => {
      if (searchTimeout) {
        clearTimeout(searchTimeout);
      }
    };
  }, [searchTimeout]);

  return (
    <div className="max-w-6xl mx-auto px-4 py-8">
      <div className="mb-4">
        <Link
          to="/"
          className="text-blue-500 hover:text-blue-600 inline-flex items-center gap-1"
        >
          <span>â†</span> è¿”å›é¦–é¡µ
        </Link>
      </div>

      <div className="flex gap-8">
        {/* ä¾§è¾¹æ  */}
        <aside className="w-64 flex-shrink-0">
          <div className="bg-white dark:bg-gray-800 rounded-lg p-6 sticky top-4">
            <h3 className="font-bold mb-4">åˆ†ç±»</h3>
            <ul className="space-y-2">
              <li>
                <button
                  onClick={() => setSelectedCategory(null)}
                  className={`w-full text-left px-3 py-2 rounded transition-colors ${
                    selectedCategory === null
                      ? "bg-blue-500 text-white"
                      : "hover:bg-gray-100 dark:hover:bg-gray-700"
                  }`}
                >
                  å…¨éƒ¨æ–‡ç« 
                </button>
              </li>
              {categories.map((cat) => (
                <li key={cat.id}>
                  <button
                    onClick={() => setSelectedCategory(cat.id)}
                    className={`w-full text-left px-3 py-2 rounded transition-colors flex justify-between ${
                      selectedCategory === cat.id
                        ? "bg-blue-500 text-white"
                        : "hover:bg-gray-100 dark:hover:bg-gray-700"
                    }`}
                  >
                    <span>{cat.name}</span>
                    <span className="text-sm">{cat.post_count}</span>
                  </button>
                </li>
              ))}
            </ul>
          </div>
        </aside>

        {/* æ–‡ç« åˆ—è¡¨ */}
        <main className="flex-1">
          {/* ğŸ”´ æœç´¢æ¡† */}
          <div className="mb-6">
            <div className="relative">
              <input
                type="text"
                value={searchQuery}
                onChange={(e) => handleSearch(e.target.value)}
                placeholder="æœç´¢æ–‡ç« æ ‡é¢˜æˆ–å†…å®¹..."
                className="w-full px-4 py-3 pl-10 border rounded-lg dark:bg-gray-800 dark:border-gray-700 focus:ring-2 focus:ring-blue-500"
              />
              <svg
                className="absolute left-3 top-3.5 w-5 h-5 text-gray-400"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  strokeLinecap="round"
                  strokeLinejoin="round"
                  strokeWidth={2}
                  d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"
                />
              </svg>

              {/* æœç´¢çŠ¶æ€æç¤º */}
              {searchQuery && (
                <button
                  onClick={() => {
                    setSearchQuery("");
                    fetchPosts();
                  }}
                  className="absolute right-3 top-3 text-gray-400 hover:text-gray-600"
                >
                  âœ•
                </button>
              )}
            </div>

            {/* æœç´¢ç»“æœæç¤º */}
            {searchQuery && !loading && (
              <p className="mt-2 text-sm text-gray-500">
                æ‰¾åˆ° {posts.length} ç¯‡åŒ…å« "{searchQuery}" çš„æ–‡ç« 
              </p>
            )}
          </div>

          <h1 className="text-3xl font-bold mb-8">
            {searchQuery ? `æœç´¢: ${searchQuery}` : "åšå®¢æ–‡ç« "}
          </h1>

          {loading ? (
            <div className="text-center py-12">åŠ è½½ä¸­...</div>
          ) : posts.length === 0 ? (
            <div className="text-center py-12 text-gray-500">
              {searchQuery ? "æ²¡æœ‰æ‰¾åˆ°ç›¸å…³æ–‡ç« " : "æš‚æ— æ–‡ç« "}
            </div>
          ) : (
            <div className="grid gap-6">
              {posts.map((post) => (
                <BlogCard key={post.id} post={post} searchQuery={searchQuery} />
              ))}
            </div>
          )}
        </main>
      </div>
    </div>
  );
};

export default BlogPage;


===== src/pages/PostPage.tsx =====
import React, { useEffect, useState } from "react";
import { useParams, Link } from "react-router-dom";
import ReactMarkdown from "react-markdown";
import remarkGfm from "remark-gfm";
import { supabase } from "../lib/supabase";
import type { Post } from "../types/blog";
import BlogComments from "../components/blog/BlogComments";
import ReadingProgress from "../components/blog/ReadingProgress";
import CodeBlock from '../components/blog/CodeBlock';


const PostPage: React.FC = () => {
  const { slug } = useParams();
  const [post, setPost] = useState<Post | null>(null);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    fetchPost();
  }, [slug]);

  const fetchPost = async () => {
    const { data } = await supabase
      .from("posts")
      .select(`*, category:categories(*)`)
      .eq("slug", slug)
      .single();

    if (data) {
      setPost(data);
      await supabase
        .from("posts")
        .update({ view_count: (data.view_count || 0) + 1 })
        .eq("id", data.id);
    }
    setLoading(false);
  };

  if (loading) return <div className="text-center py-12">åŠ è½½ä¸­...</div>;
  if (!post) return <div className="text-center py-12">æ–‡ç« ä¸å­˜åœ¨</div>;

  return (
    <>
      <ReadingProgress />
      <article className="max-w-3xl mx-auto px-4 py-8">
        {/* è¿”å›é“¾æ¥ */}
        <Link
          to="/blog"
          className="text-blue-500 hover:text-blue-600 mb-4 inline-block"
        >
          â† è¿”å›åšå®¢åˆ—è¡¨
        </Link>

        {/* æ ‡é¢˜ */}
        <h1 className="text-4xl font-bold mb-4">{post.title}</h1>

        {/* å…ƒä¿¡æ¯ */}
        <div className="flex items-center gap-4 mb-8 text-gray-500 dark:text-gray-400">
          <span>ğŸ“… {new Date(post.published_at).toLocaleDateString()}</span>
          <span>ğŸ‘ï¸ {post.view_count} é˜…è¯»</span>
          <span>â¤ï¸ {post.like_count} ç‚¹èµ</span>
        </div>

        {/* æ ‡ç­¾ */}
        {post.tags && post.tags.length > 0 && (
          <div className="flex gap-2 mb-8">
            {post.tags.map((tag) => (
              <span
                key={tag}
                className="bg-gray-100 dark:bg-gray-700 px-3 py-1 rounded-full text-sm"
              >
                #{tag}
              </span>
            ))}
          </div>
        )}

        {/* Markdownå†…å®¹ - åŒ…å«ä»£ç é«˜äº® */}
        <div className="prose dark:prose-invert max-w-none">
          <ReactMarkdown
            remarkPlugins={[remarkGfm]}
            components={{
              code: CodeBlock,
            }}
          >
            {post.content}
          </ReactMarkdown>
        </div>

        {/* è¯„è®ºç»„ä»¶ */}
        <BlogComments postId={post.id} />
      </article>
    </>
  );
};

export default PostPage;


===== src/pages/ProfilePage.tsx =====
import React, { useState, useEffect } from "react";
import { useAuthStore } from "../store/authStore";
import { supabase } from "../lib/supabase";
import { Link } from "react-router-dom";

interface ProfileData {
  username: string;
  full_name: string;
  avatar_url: string;
  bio: string;
  website: string;
  location: string;
  updated_at: string;
}

const ProfilePage: React.FC = () => {
  const { user } = useAuthStore();
  const [loading, setLoading] = useState(true);
  const [saving, setSaving] = useState(false);
  const [editing, setEditing] = useState(false);

  // ä¸ªäººèµ„æ–™æ•°æ®
  const [profile, setProfile] = useState<ProfileData>({
    username: "",
    full_name: "",
    avatar_url: "",
    bio: "",
    website: "",
    location: "",
    updated_at: "",
  });

  // ç¼–è¾‘è¡¨å•æ•°æ®
  const [formData, setFormData] = useState<ProfileData>({ ...profile });

  // å¤´åƒä¸Šä¼ ç›¸å…³
  const [uploading, setUploading] = useState(false);
  const [avatarFile, setAvatarFile] = useState<File | null>(null);
  const [avatarPreview, setAvatarPreview] = useState<string>("");

  useEffect(() => {
    if (user) {
      fetchProfile();
    }
  }, [user]);

  // è·å–ç”¨æˆ·èµ„æ–™
  const fetchProfile = async () => {
    try {
      setLoading(true);

      // ä» profiles è¡¨è·å–ç”¨æˆ·èµ„æ–™ï¼ˆå¦‚æœè¿˜æ²¡æœ‰è¿™ä¸ªè¡¨ï¼Œéœ€è¦åˆ›å»ºï¼‰
      const { data, error } = await supabase
        .from("profiles")
        .select("*")
        .eq("id", user?.id)
        .single();

      if (error && error.code !== "PGRST116") {
        // PGRST116 è¡¨ç¤ºæ²¡æœ‰æ‰¾åˆ°è®°å½•
        console.error("è·å–èµ„æ–™å¤±è´¥:", error);
      }

      if (data) {
        setProfile(data);
        setFormData(data);
        setAvatarPreview(data.avatar_url || "");
      } else {
        // å¦‚æœæ²¡æœ‰èµ„æ–™è®°å½•ï¼Œç”¨ user_metadata åˆå§‹åŒ–
        const initialData = {
          username: user?.user_metadata?.user_name || "",
          full_name: user?.user_metadata?.full_name || "",
          avatar_url: user?.user_metadata?.avatar_url || "",
          bio: "",
          website: "",
          location: "",
          updated_at: new Date().toISOString(),
        };
        setProfile(initialData);
        setFormData(initialData);
        setAvatarPreview(initialData.avatar_url);
      }
    } catch (error) {
      console.error("è·å–èµ„æ–™å¤±è´¥:", error);
    } finally {
      setLoading(false);
    }
  };

  // å¤„ç†å¤´åƒä¸Šä¼ 
  const handleAvatarChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0];
    if (!file) return;

    // éªŒè¯æ–‡ä»¶ç±»å‹
    if (!file.type.match(/image\/(jpeg|png|gif|webp)/)) {
      alert("è¯·ä¸Šä¼ å›¾ç‰‡æ–‡ä»¶ (JPEG, PNG, GIF, WEBP)");
      return;
    }

    // éªŒè¯æ–‡ä»¶å¤§å°ï¼ˆæœ€å¤§ 2MBï¼‰
    if (file.size > 2 * 1024 * 1024) {
      alert("å›¾ç‰‡å¤§å°ä¸èƒ½è¶…è¿‡ 2MB");
      return;
    }

    setAvatarFile(file);

    // åˆ›å»ºé¢„è§ˆURL
    const reader = new FileReader();
    reader.onloadend = () => {
      setAvatarPreview(reader.result as string);
    };
    reader.readAsDataURL(file);
  };

  // ä¸Šä¼ å¤´åƒåˆ° Supabase Storage
  const uploadAvatar = async (): Promise<string | null> => {
    if (!avatarFile || !user) return profile.avatar_url;

    try {
      setUploading(true);

      // ç”Ÿæˆæ–‡ä»¶å
      const fileExt = avatarFile.name.split(".").pop();
      const fileName = `${user.id}-${Date.now()}.${fileExt}`;
      const filePath = `avatars/${fileName}`;

      // ä¸Šä¼ æ–‡ä»¶
      const { error: uploadError } = await supabase.storage
        .from("avatars")
        .upload(filePath, avatarFile);

      if (uploadError) throw uploadError;

      // è·å–å…¬å…±URL
      const {
        data: { publicUrl },
      } = supabase.storage.from("avatars").getPublicUrl(filePath);

      return publicUrl;
    } catch (error) {
      console.error("å¤´åƒä¸Šä¼ å¤±è´¥:", error);
      alert("å¤´åƒä¸Šä¼ å¤±è´¥");
      return null;
    } finally {
      setUploading(false);
    }
  };

  // ä¿å­˜ä¸ªäººèµ„æ–™
  const handleSave = async () => {
    if (!user) return;

    setSaving(true);
    try {
      // å…ˆä¸Šä¼ å¤´åƒï¼ˆå¦‚æœæœ‰æ–°æ–‡ä»¶ï¼‰
      let avatarUrl = profile.avatar_url;
      if (avatarFile) {
        const newAvatarUrl = await uploadAvatar();
        if (newAvatarUrl) {
          avatarUrl = newAvatarUrl;
        }
      }

      // å‡†å¤‡è¦ä¿å­˜çš„æ•°æ®
      const profileData = {
        id: user.id,
        username: formData.username,
        full_name: formData.full_name,
        avatar_url: avatarUrl,
        bio: formData.bio,
        website: formData.website,
        location: formData.location,
        updated_at: new Date().toISOString(),
      };

      // ä¿å­˜åˆ° profiles è¡¨
      const { error } = await supabase.from("profiles").upsert(profileData);

      if (error) throw error;

      // æ›´æ–°æœ¬åœ°çŠ¶æ€
      setProfile({ ...profileData, username: formData.username });
      setEditing(false);
      setAvatarFile(null);

      alert("èµ„æ–™ä¿å­˜æˆåŠŸ");
    } catch (error) {
      console.error("ä¿å­˜å¤±è´¥:", error);
      alert("ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•");
    } finally {
      setSaving(false);
    }
  };

  // å–æ¶ˆç¼–è¾‘
  const handleCancel = () => {
    setFormData({ ...profile });
    setAvatarPreview(profile.avatar_url);
    setAvatarFile(null);
    setEditing(false);
  };

  if (loading) {
    return (
      <div className="flex justify-center items-center h-64">
        <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500"></div>
      </div>
    );
  }

  return (
    <div className="max-w-4xl mx-auto px-4 py-8">
      {/* è¿”å›é“¾æ¥ */}
      <div className="mb-6">
        <Link
          to="/"
          className="text-blue-500 hover:text-blue-600 inline-flex items-center gap-1"
        >
          <span>â†</span> è¿”å›é¦–é¡µ
        </Link>
      </div>

      {/* æ ‡é¢˜å’Œæ“ä½œæŒ‰é’® */}
      <div className="flex justify-between items-center mb-8">
        <h1 className="text-3xl font-bold">ä¸ªäººèµ„æ–™</h1>
        {!editing ? (
          <button
            onClick={() => setEditing(true)}
            className="px-6 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors"
          >
            ç¼–è¾‘èµ„æ–™
          </button>
        ) : (
          <div className="flex gap-3">
            <button
              onClick={handleCancel}
              className="px-6 py-2 bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors"
            >
              å–æ¶ˆ
            </button>
            <button
              onClick={handleSave}
              disabled={saving || uploading}
              className="px-6 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors disabled:opacity-50"
            >
              {saving || uploading ? "ä¿å­˜ä¸­..." : "ä¿å­˜ä¿®æ”¹"}
            </button>
          </div>
        )}
      </div>

      {/* ä¸ªäººèµ„æ–™å¡ç‰‡ */}
      <div className="bg-white dark:bg-gray-800 rounded-lg shadow-lg overflow-hidden">
        <div className="p-8">
          <div className="flex flex-col md:flex-row gap-8">
            {/* å·¦ä¾§ï¼šå¤´åƒåŒºåŸŸ */}
            <div className="md:w-64 flex flex-col items-center">
              <div className="relative group">
                <img
                  src={editing ? avatarPreview : profile.avatar_url}
                  alt={profile.full_name || "ç”¨æˆ·å¤´åƒ"}
                  className="w-48 h-48 rounded-full object-cover border-4 border-gray-200 dark:border-gray-700"
                  onError={(e) => {
                    e.currentTarget.src = `https://ui-avatars.com/api/?name=${profile.full_name || profile.username}&background=random&size=200`;
                  }}
                />

                {editing && (
                  <label className="absolute inset-0 flex items-center justify-center bg-black bg-opacity-50 rounded-full opacity-0 group-hover:opacity-100 transition-opacity cursor-pointer">
                    <input
                      type="file"
                      accept="image/jpeg,image/png,image/gif,image/webp"
                      onChange={handleAvatarChange}
                      className="hidden"
                    />
                    <span className="text-white text-sm">æ›´æ¢å¤´åƒ</span>
                  </label>
                )}
              </div>

              {uploading && (
                <p className="mt-2 text-sm text-gray-500">ä¸Šä¼ ä¸­...</p>
              )}
            </div>

            {/* å³ä¾§ï¼šä¿¡æ¯åŒºåŸŸ */}
            <div className="flex-1">
              {!editing ? (
                // æŸ¥çœ‹æ¨¡å¼
                <div className="space-y-6">
                  <div>
                    <h2 className="text-2xl font-bold text-gray-900 dark:text-white">
                      {profile.full_name || profile.username}
                    </h2>
                    {profile.username && (
                      <p className="text-gray-500 dark:text-gray-400 mt-1">
                        @{profile.username}
                      </p>
                    )}
                  </div>

                  {profile.bio && (
                    <div>
                      <h3 className="text-sm font-medium text-gray-500 dark:text-gray-400 mb-1">
                        ä¸ªäººç®€ä»‹
                      </h3>
                      <p className="text-gray-700 dark:text-gray-300">
                        {profile.bio}
                      </p>
                    </div>
                  )}

                  <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                    {profile.location && (
                      <div>
                        <h3 className="text-sm font-medium text-gray-500 dark:text-gray-400">
                          æ‰€åœ¨åœ°
                        </h3>
                        <p className="text-gray-700 dark:text-gray-300">
                          {profile.location}
                        </p>
                      </div>
                    )}

                    {profile.website && (
                      <div>
                        <h3 className="text-sm font-medium text-gray-500 dark:text-gray-400">
                          ä¸ªäººç½‘ç«™
                        </h3>
                        <a
                          href={profile.website}
                          target="_blank"
                          rel="noopener noreferrer"
                          className="text-blue-500 hover:text-blue-600"
                        >
                          {profile.website}
                        </a>
                      </div>
                    )}
                  </div>

                  <div className="pt-4 border-t border-gray-200 dark:border-gray-700">
                    <div className="flex items-center gap-2 text-sm text-gray-500">
                      <span>ğŸ“§ {user?.email}</span>
                    </div>
                    {profile.updated_at && (
                      <p className="text-xs text-gray-400 mt-2">
                        æœ€åæ›´æ–°:{" "}
                        {new Date(profile.updated_at).toLocaleString()}
                      </p>
                    )}
                  </div>
                </div>
              ) : (
                // ç¼–è¾‘æ¨¡å¼
                <div className="space-y-6">
                  <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                      <label className="block text-sm font-medium mb-2">
                        ç”¨æˆ·å
                      </label>
                      <input
                        type="text"
                        value={formData.username}
                        onChange={(e) =>
                          setFormData({ ...formData, username: e.target.value })
                        }
                        className="w-full px-4 py-2 border rounded-lg dark:bg-gray-700 dark:border-gray-600"
                        placeholder="ç”¨æˆ·å"
                      />
                    </div>
                    <div>
                      <label className="block text-sm font-medium mb-2">
                        å…¨å
                      </label>
                      <input
                        type="text"
                        value={formData.full_name}
                        onChange={(e) =>
                          setFormData({
                            ...formData,
                            full_name: e.target.value,
                          })
                        }
                        className="w-full px-4 py-2 border rounded-lg dark:bg-gray-700 dark:border-gray-600"
                        placeholder="ä½ çš„åå­—"
                      />
                    </div>
                  </div>

                  <div>
                    <label className="block text-sm font-medium mb-2">
                      é‚®ç®±
                    </label>
                    <input
                      type="email"
                      value={user?.email || ""}
                      disabled
                      className="w-full px-4 py-2 border rounded-lg bg-gray-100 dark:bg-gray-600 cursor-not-allowed"
                    />
                    <p className="text-xs text-gray-500 mt-1">é‚®ç®±ä¸å¯ä¿®æ”¹</p>
                  </div>

                  <div>
                    <label className="block text-sm font-medium mb-2">
                      ä¸ªäººç®€ä»‹
                    </label>
                    <textarea
                      value={formData.bio}
                      onChange={(e) =>
                        setFormData({ ...formData, bio: e.target.value })
                      }
                      rows={4}
                      className="w-full px-4 py-2 border rounded-lg dark:bg-gray-700 dark:border-gray-600"
                      placeholder="ä»‹ç»ä¸€ä¸‹è‡ªå·±..."
                    />
                  </div>

                  <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                      <label className="block text-sm font-medium mb-2">
                        æ‰€åœ¨åœ°
                      </label>
                      <input
                        type="text"
                        value={formData.location}
                        onChange={(e) =>
                          setFormData({ ...formData, location: e.target.value })
                        }
                        className="w-full px-4 py-2 border rounded-lg dark:bg-gray-700 dark:border-gray-600"
                        placeholder="åŸå¸‚ã€å›½å®¶"
                      />
                    </div>
                    <div>
                      <label className="block text-sm font-medium mb-2">
                        ä¸ªäººç½‘ç«™
                      </label>
                      <input
                        type="url"
                        value={formData.website}
                        onChange={(e) =>
                          setFormData({ ...formData, website: e.target.value })
                        }
                        className="w-full px-4 py-2 border rounded-lg dark:bg-gray-700 dark:border-gray-600"
                        placeholder="https://example.com"
                      />
                    </div>
                  </div>
                </div>
              )}
            </div>
          </div>
        </div>
      </div>
    </div>
  );
};

export default ProfilePage;


===== src/pages/admin/CategoryManager.tsx =====
import React, { useEffect, useState } from "react";
import { supabase } from "../../lib/supabase";

interface Category {
  id: number;
  name: string;
  slug: string;
  description: string;
  post_count: number;
}

const CategoryManager: React.FC = () => {
  const [categories, setCategories] = useState<Category[]>([]);
  const [newName, setNewName] = useState("");
  const [newDescription, setNewDescription] = useState("");
  const [editingId, setEditingId] = useState<number | null>(null);
  const [editName, setEditName] = useState("");
  const [editDescription, setEditDescription] = useState("");

  useEffect(() => {
    fetchCategories();
  }, []);

  const fetchCategories = async () => {
    const { data } = await supabase
      .from("categories")
      .select("*")
      .order("name");
    setCategories(data || []);
  };

  const generateSlug = (name: string) => {
    return name.toLowerCase().replace(/\s+/g, "-");
  };

  const addCategory = async () => {
    if (!newName.trim()) return;

    await supabase.from("categories").insert([
      {
        name: newName,
        slug: generateSlug(newName),
        description: newDescription,
      },
    ]);

    setNewName("");
    setNewDescription("");
    fetchCategories();
  };

  const updateCategory = async (id: number) => {
    await supabase
      .from("categories")
      .update({
        name: editName,
        slug: generateSlug(editName),
        description: editDescription,
      })
      .eq("id", id);

    setEditingId(null);
    fetchCategories();
  };

  // åˆ é™¤åˆ†ç±»
  const deleteCategory = async (id: number) => {
    // æ‰¾åˆ°è¦åˆ é™¤çš„åˆ†ç±»
    const category = categories.find((c) => c.id === id);

    // æ£€æŸ¥æ˜¯å¦æœ‰æ–‡ç« 
    if (category && category.post_count > 0) {
      alert(
        `æ— æ³•åˆ é™¤ï¼šè¯¥åˆ†ç±»ä¸‹è¿˜æœ‰ ${category.post_count} ç¯‡æ–‡ç« ï¼Œè¯·å…ˆç§»åŠ¨æˆ–åˆ é™¤è¿™äº›æ–‡ç« `,
      );
      return;
    }

    if (!window.confirm("ç¡®å®šè¦åˆ é™¤è¿™ä¸ªåˆ†ç±»å—ï¼Ÿ")) return;

    try {
      const { error } = await supabase.from("categories").delete().eq("id", id);

      if (error) throw error;

      // åˆ·æ–°åˆ—è¡¨
      fetchCategories();
    } catch (err) {
      console.error("åˆ é™¤å¤±è´¥:", err);
      alert("åˆ é™¤å¤±è´¥");
    }
  };

  return (
    <div className="max-w-4xl mx-auto px-4">
      <h1 className="text-3xl font-bold mb-8">åˆ†ç±»ç®¡ç†</h1>

      {/* æ–°å¢åˆ†ç±»è¡¨å• */}
      <div className="bg-white dark:bg-gray-800 rounded-lg p-6 mb-8">
        <h2 className="text-xl font-bold mb-4">æ–°å¢åˆ†ç±»</h2>
        <div className="space-y-4">
          <input
            type="text"
            value={newName}
            onChange={(e) => setNewName(e.target.value)}
            placeholder="åˆ†ç±»åç§°"
            className="w-full px-4 py-2 border rounded-lg dark:bg-gray-700"
          />
          <input
            type="text"
            value={newDescription}
            onChange={(e) => setNewDescription(e.target.value)}
            placeholder="åˆ†ç±»æè¿°"
            className="w-full px-4 py-2 border rounded-lg dark:bg-gray-700"
          />
          <button
            onClick={addCategory}
            className="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600"
          >
            æ·»åŠ åˆ†ç±»
          </button>
        </div>
      </div>

      {/* åˆ†ç±»åˆ—è¡¨ */}
      <div className="bg-white dark:bg-gray-800 rounded-lg overflow-hidden">
        <table className="min-w-full">
          <thead className="bg-gray-50 dark:bg-gray-700">
            <tr>
              <th className="px-6 py-3 text-left">åç§°</th>
              <th className="px-6 py-3 text-left">æè¿°</th>
              <th className="px-6 py-3 text-left">æ–‡ç« æ•°</th>
              <th className="px-6 py-3 text-right">æ“ä½œ</th>
            </tr>
          </thead>
          <tbody>
            {categories.map((cat) => (
              <tr key={cat.id} className="border-t dark:border-gray-700">
                {editingId === cat.id ? (
                  // ç¼–è¾‘æ¨¡å¼
                  <>
                    <td className="px-6 py-4">
                      <input
                        value={editName}
                        onChange={(e) => setEditName(e.target.value)}
                        className="w-full px-2 py-1 border rounded"
                      />
                    </td>
                    <td className="px-6 py-4">
                      <input
                        value={editDescription}
                        onChange={(e) => setEditDescription(e.target.value)}
                        className="w-full px-2 py-1 border rounded"
                      />
                    </td>
                    <td className="px-6 py-4">{cat.post_count}</td>
                    <td className="px-6 py-4 text-right space-x-2">
                      <button
                        onClick={() => updateCategory(cat.id)}
                        className="text-green-500 hover:text-green-700"
                      >
                        ä¿å­˜
                      </button>
                      <button
                        onClick={() => setEditingId(null)}
                        className="text-gray-500 hover:text-gray-700"
                      >
                        å–æ¶ˆ
                      </button>
                    </td>
                  </>
                ) : (
                  // æ˜¾ç¤ºæ¨¡å¼
                  <>
                    <td className="px-6 py-4">{cat.name}</td>
                    <td className="px-6 py-4">{cat.description}</td>
                    <td className="px-6 py-4">{cat.post_count}</td>
                    <td className="px-6 py-4 text-right space-x-2">
                      <button
                        onClick={() => {
                          setEditingId(cat.id);
                          setEditName(cat.name);
                          setEditDescription(cat.description || "");
                        }}
                        className="text-blue-500 hover:text-blue-700"
                      >
                        ç¼–è¾‘
                      </button>
                      <button
                        onClick={() => deleteCategory(cat.id)}
                        className="text-red-500 hover:text-red-700"
                      >
                        åˆ é™¤
                      </button>
                    </td>
                  </>
                )}
              </tr>
            ))}
          </tbody>
        </table>
      </div>
    </div>
  );
};

export default CategoryManager;


===== src/pages/admin/Dashboard.tsx =====
import React, { useEffect, useState } from "react";
import { Link } from "react-router-dom";
import { supabase } from "../../lib/supabase";

interface Stats {
  totalPosts: number;
  totalViews: number;
  totalComments: number;
  publishedPosts: number;
  draftPosts: number;
  totalCategories: number;
}

interface RecentPost {
  id: number;
  title: string;
  created_at: string;
  view_count: number;
  is_published: boolean;
}

interface CategoryStat {
  name: string;
  post_count: number;
}

const Dashboard: React.FC = () => {
  const [stats, setStats] = useState<Stats>({
    totalPosts: 0,
    totalViews: 0,
    totalComments: 0,
    publishedPosts: 0,
    draftPosts: 0,
    totalCategories: 0,
  });
  const [recentPosts, setRecentPosts] = useState<RecentPost[]>([]);
  const [categoryStats, setCategoryStats] = useState<CategoryStat[]>([]);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    fetchStats();
    fetchRecentPosts();
    fetchCategoryStats();
  }, []);

  const fetchStats = async () => {
    try {
      // æŸ¥è¯¢æ–‡ç« ç»Ÿè®¡
      const { data: posts } = await supabase
        .from("posts")
        .select("view_count, is_published");

      // æŸ¥è¯¢åˆ†ç±»æ•°é‡
      const { count: categoriesCount } = await supabase
        .from("categories")
        .select("*", { count: "exact", head: true });

      // æŸ¥è¯¢è¯„è®ºæ€»æ•°ï¼ˆå¦‚æœæœ‰è¯„è®ºè¡¨ï¼‰
      const { count: commentsCount } = await supabase
        .from("post_comments")
        .select("*", { count: "exact", head: true });

      if (posts) {
        setStats({
          totalPosts: posts.length,
          totalViews: posts.reduce((sum, p) => sum + (p.view_count || 0), 0),
          totalComments: commentsCount || 0,
          publishedPosts: posts.filter((p) => p.is_published).length,
          draftPosts: posts.filter((p) => !p.is_published).length,
          totalCategories: categoriesCount || 0,
        });
      }
    } catch (error) {
      console.error("è·å–ç»Ÿè®¡æ•°æ®å¤±è´¥:", error);
    }
  };

  const fetchRecentPosts = async () => {
    const { data } = await supabase
      .from("posts")
      .select("id, title, created_at, view_count, is_published")
      .order("created_at", { ascending: false })
      .limit(5);

    setRecentPosts(data || []);
  };

  const fetchCategoryStats = async () => {
    const { data } = await supabase
      .from("categories")
      .select("name, post_count")
      .order("post_count", { ascending: false })
      .limit(5);

    setCategoryStats(data || []);
    setLoading(false);
  };

  if (loading) {
    return (
      <div className="flex justify-center items-center h-64">
        <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500"></div>
      </div>
    );
  }

  return (
    <div className="max-w-7xl mx-auto px-4">
      <h1 className="text-3xl font-bold mb-8">ä»ªè¡¨ç›˜</h1>

      {/* ç»Ÿè®¡å¡ç‰‡ */}
      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
        {/* æ€»æ–‡ç«  */}
        <div className="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg hover:shadow-xl transition-shadow">
          <div className="flex items-center justify-between">
            <div>
              <p className="text-sm text-gray-500 dark:text-gray-400">æ€»æ–‡ç« </p>
              <p className="text-3xl font-bold text-gray-900 dark:text-white mt-2">
                {stats.totalPosts}
              </p>
            </div>
            <div className="p-3 bg-blue-100 dark:bg-blue-900 rounded-full">
              <svg
                className="w-8 h-8 text-blue-600 dark:text-blue-300"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  strokeLinecap="round"
                  strokeLinejoin="round"
                  strokeWidth={2}
                  d="M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10a2 2 0 012 2v1m2 13a2 2 0 01-2-2V7m2 13a2 2 0 002-2V9a2 2 0 00-2-2h-2m-4-3H9M7 16h6M7 8h6v4H7V8z"
                />
              </svg>
            </div>
          </div>
          <div className="mt-4 flex gap-4 text-sm">
            <span className="text-green-600">
              å·²å‘å¸ƒ: {stats.publishedPosts}
            </span>
            <span className="text-yellow-600">è‰ç¨¿: {stats.draftPosts}</span>
          </div>
        </div>

        {/* æ€»é˜…è¯»é‡ */}
        <div className="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg hover:shadow-xl transition-shadow">
          <div className="flex items-center justify-between">
            <div>
              <p className="text-sm text-gray-500 dark:text-gray-400">
                æ€»é˜…è¯»é‡
              </p>
              <p className="text-3xl font-bold text-gray-900 dark:text-white mt-2">
                {stats.totalViews.toLocaleString()}
              </p>
            </div>
            <div className="p-3 bg-green-100 dark:bg-green-900 rounded-full">
              <svg
                className="w-8 h-8 text-green-600 dark:text-green-300"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  strokeLinecap="round"
                  strokeLinejoin="round"
                  strokeWidth={2}
                  d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"
                />
                <path
                  strokeLinecap="round"
                  strokeLinejoin="round"
                  strokeWidth={2}
                  d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"
                />
              </svg>
            </div>
          </div>
        </div>

        {/* æ€»è¯„è®º */}
        <div className="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg hover:shadow-xl transition-shadow">
          <div className="flex items-center justify-between">
            <div>
              <p className="text-sm text-gray-500 dark:text-gray-400">æ€»è¯„è®º</p>
              <p className="text-3xl font-bold text-gray-900 dark:text-white mt-2">
                {stats.totalComments}
              </p>
            </div>
            <div className="p-3 bg-purple-100 dark:bg-purple-900 rounded-full">
              <svg
                className="w-8 h-8 text-purple-600 dark:text-purple-300"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  strokeLinecap="round"
                  strokeLinejoin="round"
                  strokeWidth={2}
                  d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"
                />
              </svg>
            </div>
          </div>
        </div>

        {/* å…¨éƒ¨åˆ†ç±» */}
        <div className="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg hover:shadow-xl transition-shadow">
          <div className="flex items-center justify-between">
            <div>
              <p className="text-sm text-gray-500 dark:text-gray-400">
                å…¨éƒ¨åˆ†ç±»
              </p>
              <p className="text-3xl font-bold text-gray-900 dark:text-white mt-2">
                {stats.totalCategories}
              </p>
            </div>
            <div className="p-3 bg-yellow-100 dark:bg-yellow-900 rounded-full">
              <svg
                className="w-8 h-8 text-yellow-600 dark:text-yellow-300"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  strokeLinecap="round"
                  strokeLinejoin="round"
                  strokeWidth={2}
                  d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l5 5a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-5-5A1.994 1.994 0 013 12V7a4 4 0 014-4z"
                />
              </svg>
            </div>
          </div>
        </div>
      </div>

      {/* å›¾è¡¨åŒºåŸŸ */}
      <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
        {/* æœ€è¿‘æ–‡ç«  */}
        <div className="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg">
          <h2 className="text-xl font-bold mb-4 flex items-center gap-2">
            <span>ğŸ“</span> æœ€è¿‘æ–‡ç« 
          </h2>
          <div className="space-y-3">
            {recentPosts.length > 0 ? (
              recentPosts.map((post) => (
                <div
                  key={post.id}
                  className="flex justify-between items-center p-3 bg-gray-50 dark:bg-gray-700 rounded-lg"
                >
                  <div className="flex-1">
                    <Link
                      to={`/admin/posts/edit/${post.id}`}
                      className="font-medium hover:text-blue-500"
                    >
                      {post.title}
                    </Link>
                    <div className="flex items-center gap-3 mt-1 text-sm text-gray-500">
                      <span>
                        {new Date(post.created_at).toLocaleDateString()}
                      </span>
                      <span>ğŸ‘ï¸ {post.view_count}</span>
                      <span
                        className={`px-2 py-0.5 rounded-full text-xs ${
                          post.is_published
                            ? "bg-green-100 text-green-700"
                            : "bg-yellow-100 text-yellow-700"
                        }`}
                      >
                        {post.is_published ? "å·²å‘å¸ƒ" : "è‰ç¨¿"}
                      </span>
                    </div>
                  </div>
                </div>
              ))
            ) : (
              <p className="text-gray-500 text-center py-4">æš‚æ— æ–‡ç« </p>
            )}
          </div>
          <div className="mt-4 text-right">
            <Link
              to="/admin/posts"
              className="text-blue-500 hover:text-blue-600 text-sm"
            >
              æŸ¥çœ‹å…¨éƒ¨ â†’
            </Link>
          </div>
        </div>

        {/* åˆ†ç±»ç»Ÿè®¡ */}
        <div className="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg">
          <h2 className="text-xl font-bold mb-4 flex items-center gap-2">
            <span>ğŸ“Š</span> åˆ†ç±»ç»Ÿè®¡
          </h2>
          <div className="space-y-3">
            {categoryStats.length > 0 ? (
              categoryStats.map((cat) => (
                <div
                  key={cat.name}
                  className="flex justify-between items-center p-3 bg-gray-50 dark:bg-gray-700 rounded-lg"
                >
                  <span className="font-medium">{cat.name}</span>
                  <div className="flex items-center gap-3">
                    <span className="text-sm text-gray-500">
                      {cat.post_count} ç¯‡æ–‡ç« 
                    </span>
                    <div className="w-20 h-2 bg-gray-200 dark:bg-gray-600 rounded-full overflow-hidden">
                      <div
                        className="h-full bg-blue-500 rounded-full"
                        style={{
                          width: `${Math.min(100, (cat.post_count / Math.max(...categoryStats.map((c) => c.post_count))) * 100)}%`,
                        }}
                      />
                    </div>
                  </div>
                </div>
              ))
            ) : (
              <p className="text-gray-500 text-center py-4">æš‚æ— åˆ†ç±»</p>
            )}
          </div>
          <div className="mt-4 text-right">
            <Link
              to="/admin/categories"
              className="text-blue-500 hover:text-blue-600 text-sm"
            >
              ç®¡ç†åˆ†ç±» â†’
            </Link>
          </div>
        </div>
      </div>

      {/* å¿«æ·æ“ä½œ */}
      <div className="mt-8 bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg">
        <h2 className="text-xl font-bold mb-4">âš¡ å¿«æ·æ“ä½œ</h2>
        <div className="flex flex-wrap gap-4">
          <Link
            to="/admin/posts/new"
            className="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors"
          >
            å†™æ–°æ–‡ç« 
          </Link>
          <Link
            to="/admin/categories"
            className="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors"
          >
            ç®¡ç†åˆ†ç±»
          </Link>
          <Link
            to="/blog"
            className="px-4 py-2 bg-purple-500 text-white rounded-lg hover:bg-purple-600 transition-colors"
          >
            æŸ¥çœ‹åšå®¢
          </Link>
        </div>
      </div>
    </div>
  );
};

export default Dashboard;


===== src/pages/admin/PostManager.tsx =====
import React, { useEffect, useState } from "react";
import { Link } from "react-router-dom";
import { supabase } from "../../lib/supabase";
import type { Post } from "../../types/blog";

const PostManager: React.FC = () => {
  const [posts, setPosts] = useState<Post[]>([]);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    fetchPosts();
  }, []);

  const fetchPosts = async () => {
    const { data } = await supabase
      .from("posts")
      .select("*")
      .order("created_at", { ascending: false });

    setPosts(data || []);
    setLoading(false);
  };

  const deletePost = async (id: number) => {
    if (!window.confirm("ç¡®å®šè¦åˆ é™¤è¿™ç¯‡æ–‡ç« å—ï¼Ÿ")) return;

    try {
      // 1. å…ˆè·å–æ–‡ç« çš„åˆ†ç±»ID
      const { data: post } = await supabase
        .from("posts")
        .select("category_id")
        .eq("id", id)
        .single();

      // 2. åˆ é™¤æ–‡ç« 
      const { error } = await supabase.from("posts").delete().eq("id", id);

      if (error) throw error;

      // 3. å¦‚æœæ–‡ç« æœ‰åˆ†ç±»ï¼Œåˆ†ç±»æ–‡ç« æ•°å‡1
      if (post?.category_id) {
        // å…ˆæŸ¥è¯¢å½“å‰å€¼
        const { data: category } = await supabase
          .from("categories")
          .select("post_count")
          .eq("id", post.category_id)
          .single();

        if (category) {
          await supabase
            .from("categories")
            .update({ post_count: Math.max(0, category.post_count - 1) })
            .eq("id", post.category_id);
        }
      }

      // 4. åˆ·æ–°åˆ—è¡¨
      fetchPosts();
    } catch (err) {
      console.error("åˆ é™¤å¤±è´¥:", err);
      alert("åˆ é™¤å¤±è´¥");
    }
  };

  return (
    <div className="max-w-7xl mx-auto px-4">
      <div className="flex justify-between items-center mb-8">
        <h1 className="text-3xl font-bold">æ–‡ç« ç®¡ç†</h1>
        <Link
          to="/admin/posts/new"
          className="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600"
        >
          å†™æ–°æ–‡ç« 
        </Link>
      </div>

      {loading ? (
        <div className="text-center py-12">åŠ è½½ä¸­...</div>
      ) : (
        <div className="bg-white dark:bg-gray-800 rounded-lg shadow overflow-hidden">
          <table className="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
            <thead className="bg-gray-50 dark:bg-gray-700">
              <tr>
                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                  æ ‡é¢˜
                </th>
                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                  çŠ¶æ€
                </th>
                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                  å‘å¸ƒæ—¶é—´
                </th>
                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                  é˜…è¯»é‡
                </th>
                <th className="px-6 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                  æ“ä½œ
                </th>
              </tr>
            </thead>
            <tbody className="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
              {posts.map((post) => (
                <tr key={post.id}>
                  <td className="px-6 py-4">
                    <div className="text-sm font-medium">{post.title}</div>
                  </td>
                  <td className="px-6 py-4">
                    <span
                      className={`px-2 py-1 text-xs rounded-full ${
                        post.is_published
                          ? "bg-green-100 text-green-800"
                          : "bg-yellow-100 text-yellow-800"
                      }`}
                    >
                      {post.is_published ? "å·²å‘å¸ƒ" : "è‰ç¨¿"}
                    </span>
                  </td>
                  <td className="px-6 py-4 text-sm">
                    {post.published_at
                      ? new Date(post.published_at).toLocaleDateString()
                      : "-"}
                  </td>
                  <td className="px-6 py-4 text-sm">{post.view_count}</td>
                  <td className="px-6 py-4 text-right space-x-2">
                    <Link
                      to={`/admin/posts/edit/${post.id}`}
                      className="text-blue-500 hover:text-blue-700"
                    >
                      ç¼–è¾‘
                    </Link>
                    <button
                      onClick={() => deletePost(post.id)}
                      className="text-red-500 hover:text-red-700"
                    >
                      åˆ é™¤
                    </button>
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      )}
    </div>
  );
};

export default PostManager;


===== src/pages/admin/SourceAnalysis.tsx =====
import React, { useState, useEffect } from "react";
import { getSourceStats } from "../../utils/visitLogger"; // å¯¼å…¥å·¥å…·å‡½æ•°
import {
  BarChart,
  Bar,
  XAxis,
  YAxis,
  CartesianGrid,
  Tooltip,
  ResponsiveContainer,
  PieChart,
  Pie,
  Cell,
} from "recharts";

interface SourceStats {
  total: number;
  direct: number;
  search: number;
  social: number;
  external: number;
  utm: {
    google: number;
    facebook: number;
    twitter: number;
    github: number;
    other: number;
  };
  pages: Record<string, number>;
  daily: Record<string, number>;
}

const COLORS = [
  "#3b82f6",
  "#ef4444",
  "#10b981",
  "#f59e0b",
  "#8b5cf6",
  "#ec4899",
];

const SourceAnalysis: React.FC = () => {
  const [stats, setStats] = useState<SourceStats | null>(null);
  const [loading, setLoading] = useState(true);
  const [days, setDays] = useState(30);
  const [view, setView] = useState<"overview" | "utm" | "pages">("overview");

  useEffect(() => {
    fetchStats();
  }, [days]);

  const fetchStats = async () => {
    setLoading(true);
    const data = await getSourceStats(days); // ç›´æ¥ä½¿ç”¨å·¥å…·å‡½æ•°
    setStats(data as SourceStats);
    setLoading(false);
  };

  if (loading) {
    return (
      <div className="flex justify-center items-center h-64">
        <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500"></div>
      </div>
    );
  }

  if (!stats) {
    return <div className="text-center py-12">æš‚æ— æ•°æ®</div>;
  }

  // å‡†å¤‡å›¾è¡¨æ•°æ®
  const sourceData = [
    { name: "ç›´æ¥è®¿é—®", value: stats.direct },
    { name: "æœç´¢å¼•æ“", value: stats.search },
    { name: "ç¤¾äº¤åª’ä½“", value: stats.social },
    { name: "å¤–éƒ¨é“¾æ¥", value: stats.external },
  ].filter((item) => item.value > 0);

  const utmData = [
    { name: "Google", value: stats.utm.google },
    { name: "Facebook", value: stats.utm.facebook },
    { name: "Twitter", value: stats.utm.twitter },
    { name: "GitHub", value: stats.utm.github },
    { name: "å…¶ä»–", value: stats.utm.other },
  ].filter((item) => item.value > 0);

  const pageData = Object.entries(stats.pages)
    .map(([name, value]) => ({ name, value }))
    .sort((a, b) => b.value - a.value)
    .slice(0, 10);

  const dailyData = Object.entries(stats.daily)
    .map(([date, count]) => ({ date, count }))
    .sort((a, b) => a.date.localeCompare(b.date));

  return (
    <div className="max-w-7xl mx-auto px-4 py-8">
      {/* å¤´éƒ¨å’Œç»Ÿè®¡å¡ç‰‡ä¿æŒä¸å˜ */}
      <div className="flex justify-between items-center mb-8">
        <h1 className="text-3xl font-bold">è®¿é—®æ¥æºåˆ†æ</h1>
        <div className="flex gap-2">
          <button
            onClick={() => setDays(7)}
            className={`px-3 py-1 rounded-lg text-sm ${
              days === 7 ? "bg-blue-500 text-white" : "bg-gray-100"
            }`}
          >
            è¿‘7å¤©
          </button>
          <button
            onClick={() => setDays(30)}
            className={`px-3 py-1 rounded-lg text-sm ${
              days === 30 ? "bg-blue-500 text-white" : "bg-gray-100"
            }`}
          >
            è¿‘30å¤©
          </button>
          <button
            onClick={() => setDays(90)}
            className={`px-3 py-1 rounded-lg text-sm ${
              days === 90 ? "bg-blue-500 text-white" : "bg-gray-100"
            }`}
          >
            è¿‘90å¤©
          </button>
        </div>
      </div>

      {/* ç»Ÿè®¡å¡ç‰‡ */}
      <div className="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
        <div className="bg-white dark:bg-gray-800 p-6 rounded-lg shadow">
          <div className="text-sm text-gray-500">æ€»è®¿é—®é‡</div>
          <div className="text-3xl font-bold">{stats.total}</div>
        </div>
        <div className="bg-white dark:bg-gray-800 p-6 rounded-lg shadow">
          <div className="text-sm text-gray-500">ç›´æ¥è®¿é—®</div>
          <div className="text-3xl font-bold text-blue-600">{stats.direct}</div>
        </div>
        <div className="bg-white dark:bg-gray-800 p-6 rounded-lg shadow">
          <div className="text-sm text-gray-500">æœç´¢å¼•æ“</div>
          <div className="text-3xl font-bold text-green-600">
            {stats.search}
          </div>
        </div>
        <div className="bg-white dark:bg-gray-800 p-6 rounded-lg shadow">
          <div className="text-sm text-gray-500">ç¤¾äº¤åª’ä½“</div>
          <div className="text-3xl font-bold text-purple-600">
            {stats.social}
          </div>
        </div>
      </div>

      {/* è§†å›¾åˆ‡æ¢ */}
      <div className="flex gap-2 mb-6">
        <button
          onClick={() => setView("overview")}
          className={`px-4 py-2 rounded-lg ${
            view === "overview" ? "bg-blue-500 text-white" : "bg-gray-100"
          }`}
        >
          æ¥æºæ¦‚è§ˆ
        </button>
        <button
          onClick={() => setView("utm")}
          className={`px-4 py-2 rounded-lg ${
            view === "utm" ? "bg-blue-500 text-white" : "bg-gray-100"
          }`}
        >
          UTMåˆ†æ
        </button>
        <button
          onClick={() => setView("pages")}
          className={`px-4 py-2 rounded-lg ${
            view === "pages" ? "bg-blue-500 text-white" : "bg-gray-100"
          }`}
        >
          çƒ­é—¨é¡µé¢
        </button>
      </div>

      {/* å›¾è¡¨åŒºåŸŸ - ä¿æŒä¸å˜ */}
      <div className="bg-white dark:bg-gray-800 p-6 rounded-lg shadow">
        {view === "overview" && (
          <>
            <h2 className="text-xl font-bold mb-4">æ¥æºåˆ†å¸ƒ</h2>
            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div className="h-80">
                <ResponsiveContainer width="100%" height="100%">
                  <PieChart>
                    <Pie
                      data={sourceData}
                      cx="50%"
                      cy="50%"
                      labelLine={false}
                      label={(entry) => `${entry.name}: ${entry.value}`}
                      outerRadius={80}
                      fill="#8884d8"
                      dataKey="value"
                    >
                      {sourceData.map((_entry, index) => (
                        <Cell
                          key={`cell-${index}`}
                          fill={COLORS[index % COLORS.length]}
                        />
                      ))}
                    </Pie>
                    <Tooltip />
                  </PieChart>
                </ResponsiveContainer>
              </div>

              <div className="h-80">
                <ResponsiveContainer width="100%" height="100%">
                  <BarChart data={dailyData}>
                    <CartesianGrid strokeDasharray="3 3" />
                    <XAxis dataKey="date" />
                    <YAxis />
                    <Tooltip />
                    <Bar dataKey="count" fill="#3b82f6" />
                  </BarChart>
                </ResponsiveContainer>
              </div>
            </div>
          </>
        )}

        {view === "utm" && utmData.length > 0 && (
          <>
            <h2 className="text-xl font-bold mb-4">UTM æ¥æºåˆ†æ</h2>
            <div className="h-96">
              <ResponsiveContainer width="100%" height="100%">
                <BarChart data={utmData} layout="vertical">
                  <CartesianGrid strokeDasharray="3 3" />
                  <XAxis type="number" />
                  <YAxis type="category" dataKey="name" />
                  <Tooltip />
                  <Bar dataKey="value" fill="#3b82f6" />
                </BarChart>
              </ResponsiveContainer>
            </div>
          </>
        )}

        {view === "pages" && (
          <>
            <h2 className="text-xl font-bold mb-4">çƒ­é—¨é¡µé¢ TOP 10</h2>
            <div className="h-96">
              <ResponsiveContainer width="100%" height="100%">
                <BarChart
                  data={pageData}
                  layout="vertical"
                  margin={{ left: 200 }}
                >
                  <CartesianGrid strokeDasharray="3 3" />
                  <XAxis type="number" />
                  <YAxis type="category" dataKey="name" width={150} />
                  <Tooltip />
                  <Bar dataKey="value" fill="#3b82f6" />
                </BarChart>
              </ResponsiveContainer>
            </div>
          </>
        )}
      </div>
    </div>
  );
};

export default SourceAnalysis;


===== src/store/authStore.ts =====
import { create } from 'zustand';
import { persist, createJSONStorage } from 'zustand/middleware';
import { supabase } from '../lib/supabase';
import type { User } from '@supabase/supabase-js';

interface AuthState {
  // çŠ¶æ€
  user: User | null;
  isLoading: boolean;
  error: string | null;
  
  // æ–¹æ³•
  signInWithGitHub: () => Promise<void>;
  signOut: () => Promise<void>;
  initialize: () => Promise<void>;
  clearError: () => void;
}

export const useAuthStore = create<AuthState>()(
  persist(
    (set, _get) => ({
      // åˆå§‹çŠ¶æ€
      user: null,
      isLoading: true,
      error: null,

      // GitHub ç™»å½•
      signInWithGitHub: async () => {
        try {
          set({ isLoading: true, error: null });
          
          const { error } = await supabase.auth.signInWithOAuth({
            provider: 'github',
            options: {
              redirectTo: window.location.origin,
              scopes: 'read:user user:email'  // è¯·æ±‚æ›´å¤šæƒé™
            }
          });

          if (error) throw error;
          
        } catch (error: any) {
          set({ error: error.message });
        } finally {
          set({ isLoading: false });
        }
      },

      // é€€å‡ºç™»å½•
      signOut: async () => {
        try {
          set({ isLoading: true });
          await supabase.auth.signOut();
          set({ user: null });
        } catch (error: any) {
          set({ error: error.message });
        } finally {
          set({ isLoading: false });
        }
      },

      // åˆå§‹åŒ–ï¼šæ£€æŸ¥å½“å‰ç™»å½•çŠ¶æ€
      initialize: async () => {
        try {
          set({ isLoading: true });
          
          // è·å–å½“å‰ä¼šè¯
          const { data: { session } } = await supabase.auth.getSession();
          
          if (session?.user) {
            set({ user: session.user });
          }

        } catch (error: any) {
          set({ error: error.message });
        } finally {
          set({ isLoading: false });
        }
      },

      // æ¸…é™¤é”™è¯¯
      clearError: () => set({ error: null })
    }),
    {
      name: 'auth-storage', // localStorage çš„ key
      storage: createJSONStorage(() => localStorage),
      partialize: (state) => ({ user: state.user }) // åªæŒä¹…åŒ– user
    }
  )
);

===== src/store/likeStore.ts =====
// src/store/likeStore.ts
import { create } from 'zustand';
import { supabase } from '../lib/supabase';
import { useAuthStore } from './authStore';

interface LikeState {
  likedMessages: Set<number>;
  loading: boolean;
  fetchUserLikes: () => Promise<void>;
  toggleLike: (messageId: number) => Promise<void>;
}

export const useLikeStore = create<LikeState>((set, get) => ({
  likedMessages: new Set(),
  loading: false,

  fetchUserLikes: async () => {
    const user = useAuthStore.getState().user;
    if (!user) return;

    // æ–°å¢ï¼šå¦‚æœå·²ç»åœ¨åŠ è½½ä¸­ï¼Œç›´æ¥è¿”å›
    if (get().loading) return;

    // æ–°å¢ï¼šå¦‚æœå·²ç»æœ‰æ•°æ®ï¼Œä¸å†é‡å¤è¯·æ±‚
    if (get().likedMessages.size > 0) return;


    try {
      set({ loading: true });
      const { data } = await supabase
          .from('message_likes')
          .select('message_id')
          .eq('user_id', user.id);

      if (data) {
        set({ likedMessages: new Set(data.map(like => like.message_id)) });
      }
    } catch (error) {
      console.error('Error fetching likes:', error);
    } finally {
      set({ loading: false });
    }
  },

  toggleLike: async (messageId: number) => {
    const user = useAuthStore.getState().user;
    if (!user) {
      alert('è¯·å…ˆç™»å½•åå†ç‚¹èµ');
      return;
    }

    const { likedMessages } = get();
    const isLiked = likedMessages.has(messageId);

    try {
      // å…ˆæŸ¥è¯¢å½“å‰ç‚¹èµæ•°
      const { data: message, error: queryError } = await supabase
          .from('messages')
          .select('likes_count')
          .eq('id', messageId)
          .single();

      if (queryError) throw queryError;

      const currentLikes = message?.likes_count || 0;

      if (isLiked) {
        // å–æ¶ˆç‚¹èµï¼šåˆ é™¤ç‚¹èµè®°å½•
        const { error: deleteError } = await supabase
            .from('message_likes')
            .delete()
            .eq('message_id', messageId)
            .eq('user_id', user.id);

        if (deleteError) throw deleteError;

        // æ›´æ–° messages è¡¨çš„ç‚¹èµæ•°ï¼ˆå‡1ï¼‰
        const { error: updateError } = await supabase
            .from('messages')
            .update({ likes_count: Math.max(0, currentLikes - 1) })
            .eq('id', messageId);

        if (updateError) throw updateError;

        likedMessages.delete(messageId);
      } else {
        // æ·»åŠ ç‚¹èµï¼šæ’å…¥ç‚¹èµè®°å½•
        const { error: insertError } = await supabase
            .from('message_likes')
            .insert({ message_id: messageId, user_id: user.id });

        if (insertError) throw insertError;

        // æ›´æ–° messages è¡¨çš„ç‚¹èµæ•°ï¼ˆåŠ 1ï¼‰
        const { error: updateError } = await supabase
            .from('messages')
            .update({ likes_count: currentLikes + 1 })
            .eq('id', messageId);

        if (updateError) throw updateError;

        likedMessages.add(messageId);
      }

      set({ likedMessages: new Set(likedMessages) });
    } catch (error) {
      console.error('Error toggling like:', error);
    }
  },
}));

===== src/types/blog.ts =====
/**
 * åˆ†ç±»æ¥å£
 * å¯¹åº”æ•°æ®åº“ä¸­çš„ categories è¡¨
 */
export interface Category {
  id: number;              // åˆ†ç±»å”¯ä¸€IDï¼Œä¸»é”®
  name: string;            // åˆ†ç±»åç§°ï¼ˆå¦‚ï¼šæŠ€æœ¯ã€ç”Ÿæ´»ã€ç¬”è®°ï¼‰
  slug: string;            // URLå‹å¥½çš„å”¯ä¸€æ ‡è¯†ï¼ˆå¦‚ï¼štechã€lifeï¼‰
  description?: string;    // åˆ†ç±»æè¿°ï¼ˆå¯é€‰ï¼‰
  post_count: number;      // è¯¥åˆ†ç±»ä¸‹çš„æ–‡ç« æ•°é‡
}

/**
 * æ–‡ç« æ¥å£
 * å¯¹åº”æ•°æ®åº“ä¸­çš„ posts è¡¨
 */
export interface Post {
  id: number;              // æ–‡ç« å”¯ä¸€IDï¼Œä¸»é”®
  title: string;           // æ–‡ç« æ ‡é¢˜
  slug: string;            // URLå‹å¥½çš„å”¯ä¸€æ ‡è¯†ï¼ˆå¦‚ï¼šmy-first-postï¼‰
  content: string;         // æ–‡ç« å†…å®¹ï¼ˆMarkdownæ ¼å¼ï¼‰
  excerpt?: string;        // æ–‡ç« æ‘˜è¦ï¼ˆå¯é€‰ï¼Œä¸æä¾›åˆ™è‡ªåŠ¨æˆªå–å†…å®¹ï¼‰
  cover_image?: string;    // å°é¢å›¾ç‰‡URLåœ°å€ï¼ˆå¯é€‰ï¼‰
  category?: Category;     // æ‰€å±åˆ†ç±»ä¿¡æ¯ï¼ˆå…³è”categoriesè¡¨ï¼‰
  tags: string[];          // æ–‡ç« æ ‡ç­¾æ•°ç»„ï¼ˆå¦‚ï¼š['React', 'TypeScript']ï¼‰
  view_count: number;      // æµè§ˆæ¬¡æ•°
  like_count: number;      // ç‚¹èµæ¬¡æ•°
  comment_count: number;   // è¯„è®ºæ¬¡æ•°
  is_published: boolean;   // ğŸ”´ æ–°å¢ï¼šæ˜¯å¦å·²å‘å¸ƒï¼ˆè‰ç¨¿/å‘å¸ƒçŠ¶æ€ï¼‰
  published_at: string;    // å®é™…å‘å¸ƒæ—¶é—´ï¼ˆISOæ ¼å¼æ—¶é—´å­—ç¬¦ä¸²ï¼‰
  created_at: string;      // åˆ›å»ºæ—¶é—´ï¼ˆISOæ ¼å¼æ—¶é—´å­—ç¬¦ä¸²ï¼‰
  updated_at?: string;     // ğŸ”´ æ–°å¢ï¼šæœ€åæ›´æ–°æ—¶é—´ï¼ˆå¯é€‰ï¼‰
  user_id?: string;        // ğŸ”´ æ–°å¢ï¼šä½œè€…IDï¼ˆå¯é€‰ï¼Œç”¨äºå…³è”ï¼‰
  author?: {               // ä½œè€…ä¿¡æ¯ï¼ˆå¯é€‰ï¼Œå…³è”auth.usersè¡¨ï¼‰
    name: string;          // ä½œè€…åç§°ï¼ˆä»user_metadataä¸­è·å–ï¼‰
    avatar?: string;       // ä½œè€…å¤´åƒURLï¼ˆå¯é€‰ï¼‰
  };
}

/**
 * æ–‡ç« è¯„è®ºæ¥å£
 * å¯¹åº”æ•°æ®åº“ä¸­çš„ post_comments è¡¨
 */
export interface PostComment {
  id: number;              // è¯„è®ºå”¯ä¸€IDï¼Œä¸»é”®
  post_id: number;         // æ‰€å±æ–‡ç« IDï¼Œå…³è”postsè¡¨
  user_id: string;         // è¯„è®ºç”¨æˆ·IDï¼Œå…³è”auth.usersè¡¨
  content: string;         // è¯„è®ºå†…å®¹
  likes_count: number;     // è¯„è®ºç‚¹èµæ•°
  created_at: string;      // è¯„è®ºæ—¶é—´ï¼ˆISOæ ¼å¼æ—¶é—´å­—ç¬¦ä¸²ï¼‰
  user?: {                 // ç”¨æˆ·ä¿¡æ¯ï¼ˆå¯é€‰ï¼Œå…³è”auth.usersè¡¨ï¼‰
    name: string;          // ç”¨æˆ·åç§°ï¼ˆä»user_metadataä¸­è·å–ï¼‰
    avatar?: string;       // ç”¨æˆ·å¤´åƒURLï¼ˆå¯é€‰ï¼‰
  };
}

===== src/types/index.ts =====
// å®šä¹‰æŠ€èƒ½ä¿¡æ¯
export interface Skill {
  name: string; // æŠ€èƒ½åç§°ï¼Œå­—ç¬¦ä¸²ç±»å‹
  level: "Beginner" | "Intermediate" | "Advanced"; // æŠ€èƒ½ç­‰çº§ï¼Œåªèƒ½æ˜¯è¿™ä¸‰ä¸ªå€¼ä¹‹ä¸€
}

// å®šä¹‰é¡¹ç›®ç»å†
export interface Project {
  name: string; // é¡¹ç›®åç§°
  description: string; // é¡¹ç›®æè¿°
  link?: string; // å¯é€‰ï¼Œé¡¹ç›®é“¾æ¥
  category?: string;    // æ–°å¢
  tags?: string[];      // æ–°å¢
}

// å®šä¹‰æ•™è‚²ç»å†
export interface Education {
  school: string; // å­¦æ ¡åç§°
  degree: string; // å­¦ä½
  startYear: number; // å…¥å­¦å¹´ä»½
  endYear: number; // æ¯•ä¸šå¹´ä»½
}

// å®šä¹‰è”ç³»æ–¹å¼
export interface ContactInfo {
  email: string; // å¿…å¡«é‚®ç®±
  phone?: string; // å¯é€‰ç”µè¯
  github?: string; // å¯é€‰ GitHub åœ°å€
  linkedin?: string; // å¯é€‰ LinkedIn åœ°å€
}

// å®šä¹‰ä¸ªäººç®€ä»‹ä¿¡æ¯
export interface AboutInfo {
  bio: string; // ç®€ä»‹æ–‡å­—
  avatar?: string; // å¯é€‰å¤´åƒ URL
}

// æ·»åŠ  Message ç±»å‹
export interface Message {
  id: number;
  name: string;
  content: string;
  created_at: string;
  avatar_url?: string;
  user_id?: string;
  likes_count?: number;
  is_pinned?: boolean; 
  reactions?: {  // æ–°å¢ï¼šç•™è¨€çš„è¡¨æƒ…ç»Ÿè®¡
    [key: string]: number;  // å¦‚ { 'ğŸ‘': 3, 'â¤ï¸': 2 }
  };
  user_reactions?: string[]; // æ–°å¢ï¼šå½“å‰ç”¨æˆ·æ·»åŠ äº†å“ªäº›è¡¨æƒ…
}

export interface MessageWithLike extends Message {
  liked_by_user?: boolean;
}

// æ·»åŠ è¡¨æƒ…ååº”ç±»å‹
export interface MessageReaction {
  id: number;
  message_id: number;
  user_id: string;
  reaction: string;
  created_at: string;
}

===== src/types/vite-pwa.d.ts =====
// src/vite-pwa.d.ts

/// <reference types="vite-plugin-pwa/react" />

declare module "virtual:pwa-register" {
  import { RegisterSWOptions } from "vite-plugin-pwa";

  export function registerSW(options?: RegisterSWOptions): (reloadPage?: boolean) => Promise<void>;
}

===== src/utils/visitLogger.ts =====
import { supabase } from '../lib/supabase';

interface VisitData {
  path: string;
  referer?: string;
  utm_source?: string;
  utm_medium?: string;
  utm_campaign?: string;
  utm_term?: string;
  utm_content?: string;
}

// è§£æ UTM å‚æ•°
const parseUTMParams = (url: string): Partial<VisitData> => {
  try {
    const urlObj = new URL(url, window.location.origin);
    const params = urlObj.searchParams;
    
    return {
      utm_source: params.get('utm_source') || undefined,
      utm_medium: params.get('utm_medium') || undefined,
      utm_campaign: params.get('utm_campaign') || undefined,
      utm_term: params.get('utm_term') || undefined,
      utm_content: params.get('utm_content') || undefined,
    };
  } catch {
    return {};
  }
};

// è·å–æ¥æºé¡µé¢
const getReferer = (): string | undefined => {
  return document.referrer || undefined;
};


// è·å–æ¥æºé¡µé¢ï¼ˆæµ‹è¯•ä»£ç ï¼‰
/*
const getReferer = (): string | undefined => {
  // return document.referrer || undefined;

  // æµ‹è¯•ç”¨ï¼šæ ¹æ® URL å‚æ•°åŠ¨æ€è¿”å›
  const url = new URL(window.location.href);
  const testSource = url.searchParams.get('test_source');

  if (testSource === 'google') return 'https://www.google.com';
  if (testSource === 'facebook') return 'https://www.facebook.com';
  if (testSource === 'github') return 'https://github.com';

  return undefined;
};
*/


// è®°å½•è®¿é—®
export const logVisit = async () => {
  try {
    const currentPath = window.location.pathname + window.location.search;
    const referer = getReferer();
    const utmParams = parseUTMParams(window.location.href);

    const visitData: VisitData = {
      path: currentPath,
      referer,
      ...utmParams
    };

    // å¼‚æ­¥è®°å½•ï¼Œä¸é˜»å¡é¡µé¢åŠ è½½
    supabase
        .from('visit_logs')
        .insert([visitData])
        .then(({ error }) => {
          if (error) console.error('è®°å½•è®¿é—®å¤±è´¥:', error);
        });
  } catch (error) {
    console.error('è®°å½•è®¿é—®å‡ºé”™:', error);
  }
};

// è·å–æ¥æºç»Ÿè®¡
export const getSourceStats = async (days: number = 30) => {
  const startDate = new Date();
  startDate.setDate(startDate.getDate() - days);
  
  const { data, error } = await supabase
    .from('visit_logs')
    .select('*')
    .gte('visited_at', startDate.toISOString());
  
  if (error) {
    console.error('è·å–ç»Ÿè®¡å¤±è´¥:', error);
    return null;
  }
  
  return analyzeSources(data || []);
};

// åˆ†ææ¥æºæ•°æ®
const analyzeSources = (logs: any[]) => {
  const stats = {
    total: logs.length,
    direct: 0,           // ç›´æ¥è®¿é—®
    search: 0,           // æœç´¢å¼•æ“
    social: 0,           // ç¤¾äº¤åª’ä½“
    external: 0,         // å¤–éƒ¨é“¾æ¥
    utm: {
      google: 0,
      facebook: 0,
      twitter: 0,
      github: 0,
      other: 0
    },
    pages: {} as Record<string, number>,
    daily: {} as Record<string, number>
  };

  logs.forEach(log => {
    // æŒ‰å¤©ç»Ÿè®¡
    const day = log.visited_at.split('T')[0];
    stats.daily[day] = (stats.daily[day] || 0) + 1;

    // æŒ‰é¡µé¢ç»Ÿè®¡
    stats.pages[log.path] = (stats.pages[log.path] || 0) + 1;

    // åˆ†ææ¥æº
    // åˆ†ææ¥æºï¼ˆä¸ç»Ÿè®¡ UTMï¼‰
    if (!log.referer) {
      stats.direct++;
    } else if (log.referer.includes('google.com')) {
      stats.search++;
    } else if (log.referer.includes('facebook.com')) {
      stats.social++;
    } else if (log.referer.includes('twitter.com')) {
      stats.social++;
    } else if (log.referer.includes('github.com')) {
      stats.external++;
    } else {
      stats.external++;
    }

    // å•ç‹¬ç»Ÿè®¡ UTM
    if (log.utm_source) {
      if (log.utm_source === 'google') stats.utm.google++;
      else if (log.utm_source === 'facebook') stats.utm.facebook++;
      else if (log.utm_source === 'twitter') stats.utm.twitter++;
      else if (log.utm_source === 'github') stats.utm.github++;
      else stats.utm.other++;
    }
  });

  return stats;
};

===== tailwind.config.js =====
/** @type {import('tailwindcss').Config} */
export default {
  darkMode: "class", // âœ… ç¡®ä¿æ˜¯ class æ¨¡å¼
  content: ["./index.html", "./src/**/*.{js,ts,jsx,tsx}"],
  theme: {
    extend: {
      colors: {
        // å¯ä»¥åœ¨è¿™é‡Œæ‰©å±•è‡ªå®šä¹‰é¢œè‰²
      },
    },
  },
  plugins: [],
};


===== vite.config.ts =====
// vite.config.ts
import { defineConfig } from 'vite';
import react from '@vitejs/plugin-react';
import path from 'path';
import { VitePWA } from 'vite-plugin-pwa'


export default defineConfig({
  plugins: [
    react(),
    VitePWA({
      registerType: 'autoUpdate', // è‡ªåŠ¨æ›´æ–° Service Worker
      includeAssets: ['favicon.ico', 'apple-touch-icon.png', 'masked-icon.svg'], // éœ€è¦ç¼“å­˜çš„é™æ€èµ„æº
      manifest: {
        name: 'æˆ‘çš„ä¸ªäººåšå®¢', // åº”ç”¨å…¨å
        short_name: 'MyBlog', // åº”ç”¨çŸ­åï¼ˆæ˜¾ç¤ºåœ¨æ¡Œé¢ä¸Šï¼‰
        description: 'ä¸€ä¸ªåŸºäº React å’Œ Supabase çš„ä¸ªäººåšå®¢ç³»ç»Ÿ',
        theme_color: '#ffffff', // æµè§ˆå™¨åœ°å€æ é¢œè‰²
        background_color: '#ffffff', // å¯åŠ¨é¡µèƒŒæ™¯è‰²
        display: 'standalone', // éšè—æµè§ˆå™¨åœ°å€æ ï¼ŒåƒåŸç”ŸApp
        scope: '/',
        start_url: '/',
        icons: [
          {
            src: 'pwa-192x192.png', // ç¡®ä¿ä½ åœ¨ public æ–‡ä»¶å¤¹ä¸‹æœ‰è¿™äº›å›¾ç‰‡
            sizes: '192x192',
            type: 'image/png'
          },
          {
            src: 'pwa-512x512.png',
            sizes: '512x512',
            type: 'image/png'
          },
          {
            src: 'pwa-512x512.png',
            sizes: '512x512',
            type: 'image/png',
            purpose: 'any maskable' // æ”¯æŒå®‰å“è‡ªé€‚åº”å›¾æ ‡
          }
        ]
      },
      workbox: {
        globPatterns: ['**/*.{js,css,html,ico,png,svg,woff2}'], // ç¼“å­˜çš„æ–‡ä»¶ç±»å‹
        // ç­–ç•¥é…ç½®ï¼šé’ˆå¯¹ API è¯·æ±‚ä½¿ç”¨ç½‘ç»œä¼˜å…ˆï¼Œé™æ€èµ„æºä½¿ç”¨ç¼“å­˜ä¼˜å…ˆ
        runtimeCaching: [
          {
            urlPattern: /^https:\/\/.*\.supabase\.co\/.*/i, // ç¼“å­˜ Supabase çš„å›¾ç‰‡æˆ–èµ„æº
            handler: 'CacheFirst',
            options: {
              cacheName: 'supabase-assets',
              expiration: {
                maxEntries: 50,
                maxAgeSeconds: 60 * 60 * 24 * 30 // 30å¤©
              },
              cacheableResponse: {
                statuses: [0, 200]
              }
            }
          }
        ]
      }
    })
  ],
  resolve: {
    alias: {
      '@': path.resolve(__dirname, 'src'),
    },
  },
});

